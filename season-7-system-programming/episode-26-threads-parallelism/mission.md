# –ë—Ä–∏—Ñ–∏–Ω–≥ –º–∏—Å—Å–∏–∏: Threads & Parallelism
## Episode 26 ‚Äî –ì–æ–Ω–∫–∞ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º

---

## üéØ –¶–µ–ª—å –º–∏—Å—Å–∏–∏

**–°–†–û–ß–ù–û:** –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å 324 –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –≤—Ä–∞–∂–µ—Å–∫–∏—Ö –ø–∞–∫–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É.  
**–í–´–ó–û–í:** Single-threaded = 32 –º–∏–Ω—É—Ç—ã. Multi-threaded (8 —è–¥–µ—Ä) = 4 –º–∏–Ω—É—Ç—ã.  
**–î–ï–î–õ–ê–ô–ù:** –ù–∞–π—Ç–∏ packet 047 (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π intelligence) –¥–æ —Ç–æ–≥–æ –∫–∞–∫ –≤—Ä–∞–≥ —Å–º–µ–Ω–∏—Ç —Ç–∞–∫—Ç–∏–∫—É.  
**–õ–ò–ú–ò–¢ –í–†–ï–ú–ï–ù–ò:** ~9 —á–∞—Å–æ–≤ –¥–æ –≤—Ä–∞–∂–µ—Å–∫–æ–≥–æ deep scan (Dec 25, 03:00)

---

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –º–∏—Å—Å–∏–∏

### 1. –°–æ–∑–¥–∞–Ω–∏–µ Thread Pool
- ‚úÖ –°–æ–∑–¥–∞—Ç—å 8 worker threads (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç CPU —è–¥—Ä–∞–º)
- ‚úÖ Thread-safe –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á (bounded buffer, –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å 50)
- ‚úÖ Producer thread (–∑–∞–≥—Ä—É–∑–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ –∏–∑ Episode 25)
- ‚úÖ Consumer threads (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)

### 2. Producer-Consumer Pattern
- ‚úÖ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è bounded buffer
- ‚úÖ –ó–∞—â–∏—Ç–∞ mutex (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –æ—á–µ—Ä–µ–¥–∏)
- ‚úÖ Condition variables (not_empty, not_full)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏ (producer –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç–æ–π –æ—á–µ—Ä–µ–¥–∏ (consumers –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è)
- ‚úÖ Graceful shutdown (broadcast –≤—Å–µ–º –ø–æ—Ç–æ–∫–∞–º)

### 3. –ü—Ä–∏–º–∏—Ç–∏–≤—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- ‚úÖ pthread_mutex (–∑–∞—â–∏—Ç–∞ —Ä–∞–∑–¥–µ–ª—è–µ–º–æ–π –ø–∞–º—è—Ç–∏)
- ‚úÖ pthread_cond (–º–µ—Ö–∞–Ω–∏–∑–º signal/wait)
- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–¥–ª—è —Å—á—ë—Ç—á–∏–∫–æ–≤)
- ‚úÖ Memory barriers (–æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏)

### 4. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ Race Condition
- ‚úÖ –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–¥–µ–ª—è–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (queue, counters, buffers)
- ‚úÖ –ó–∞—â–∏—Ç–∏—Ç—å mutex –∏–ª–∏ –∞—Ç–æ–º–∞—Ä–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
- ‚úÖ –ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–µ–∫—Ü–∏–∏ (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ)
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å thread sanitizer (–±–µ–∑ data races)

### 5. –ò–∑–±–µ–≥–∞–Ω–∏–µ Deadlock
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ (–≤—Å–µ–≥–¥–∞ A‚ÜíB‚ÜíC, –Ω–∏–∫–æ–≥–¥–∞ B‚ÜíA)
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è (–∏–µ—Ä–∞—Ä—Ö–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫)
- ‚úÖ –¢–∞–π–º–∞—É—Ç –Ω–∞ –∑–∞—Ö–≤–∞—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (pthread_mutex_timedlock)
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ —Å—Ç—Ä–µ—Å—Å–æ–≤—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö (–¥–∏—Å–±–∞–ª–∞–Ω—Å producer/consumer)

### 6. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –î–æ—Å—Ç–∏—á—å —É—Å–∫–æ—Ä–µ–Ω–∏—è 7-8x (8 –ø–æ—Ç–æ–∫–æ–≤ vs 1 –ø–æ—Ç–æ–∫)
- ‚úÖ –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏ (—Ä–∞–±–æ—Ç–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ)
- ‚úÖ –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è lock contention (–∫–æ—Ä–æ—Ç–∫–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–µ–∫—Ü–∏–∏)
- ‚úÖ Cache-friendly —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö

---

## üß™ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–µ—Å—Ç—ã Thread Pool
```bash
# –°–æ–∑–¥–∞—Ç—å thread pool
./threads_test --create-pool 8

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ—Ç–æ–∫–æ–≤
ps -T -p <PID>  # –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å 9 –ø–æ—Ç–æ–∫–æ–≤ (1 main + 8 workers)

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å thread IDs (Linux)
cat /proc/<PID>/task/*/status | grep Tgid  # Linux
# macOS/FreeBSD: ps -M -p <PID> –∏–ª–∏ lldb attach
```

### –¢–µ—Å—Ç—ã Producer-Consumer
```bash
# –¢–µ—Å—Ç –ø—É—Å—Ç–æ–π –æ—á–µ—Ä–µ–¥–∏ (consumers –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è)
./threads_test --producer-slow --consumers-fast

# –¢–µ—Å—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ (producer –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è)
./threads_test --producer-fast --consumers-slow

# –¢–µ—Å—Ç –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ (steady state)
./threads_test --balanced
```

### –¢–µ—Å—Ç—ã Race Condition
```bash
# –ë–µ–∑ mutex (–¥–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö)
./threads_test --no-mutex --increments 10000
# –û–∂–∏–¥–∞–µ—Ç—Å—è: counter < 20000 (–ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)

# –° mutex (–¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç)
./threads_test --with-mutex --increments 10000
# –û–∂–∏–¥–∞–µ—Ç—Å—è: counter == 20000 (–∏–¥–µ–∞–ª—å–Ω–æ)

# Thread sanitizer
gcc -fsanitize=thread threads.c -lpthread
./a.out
# –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å data races
```

### –¢–µ—Å—Ç—ã Deadlock
```bash
# –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ (–¥–æ–ª–∂–µ–Ω deadlock)
./threads_test --deadlock-demo

# –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ (–¥–æ–ª–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è)
./threads_test --no-deadlock
```

### –¢–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
```bash
# Single-threaded baseline
time ./threads_test --threads 1 --packets 324
# –û–∂–∏–¥–∞–µ—Ç—Å—è: ~32 —Å–µ–∫—É–Ω–¥—ã

# Multi-threaded (8 threads)
time ./threads_test --threads 8 --packets 324
# –û–∂–∏–¥–∞–µ—Ç—Å—è: ~4 —Å–µ–∫—É–Ω–¥—ã (7-8x speedup)
```

---

## üì¶ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–∏—Å—Å–∏–∏

### –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (3 —Ñ–∞–π–ª–∞, 926 —Å—Ç—Ä–æ–∫):
- ‚úÖ `thread_analysis_log.txt` (372 —Å—Ç—Ä–æ–∫–∏)
  - –¢–∞–π–º–ª–∞–π–Ω –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ thread pool
  - –õ–æ–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è producer-consumer
  - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Ö–æ–¥–∫–∞ packet 047 (18:02:00)
  - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (—É—Å–∫–æ—Ä–µ–Ω–∏–µ 7.6x)
  - –ê–Ω–∞–ª–∏–∑ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏
  
- ‚úÖ `race_condition_demo.log` (238 —Å—Ç—Ä–æ–∫)
  - Race condition –±–µ–∑ mutex (–¥–µ–º–æ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö)
  - Race condition —Å mutex (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)
  - –°—Ü–µ–Ω–∞—Ä–∏–π deadlock (2 mutex, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫)
  - –ò–∑–±–µ–≥–∞–Ω–∏–µ deadlock (–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫)
  - Thread starvation (priority inversion)
  - –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ vs mutex (—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
  
- ‚úÖ `producer_consumer_detailed.log` (316 —Å—Ç—Ä–æ–∫)
  - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è bounded buffer
  - Producer –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ (—Ç–∞–π–º–ª–∞–π–Ω)
  - Consumer –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –ø—É—Å—Ç–æ–π –æ—á–µ—Ä–µ–¥–∏ (—Ç–∞–π–º–ª–∞–π–Ω)
  - –¢—Ä–µ–π—Å—ã mutex/condition variable
  - –ê–Ω–∞–ª–∏–∑ steady state (–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞)
  - –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å shutdown (graceful termination)

### –ö–æ–¥:
- ‚úÖ `solution/threads_parallelism.c` (500 —Å—Ç—Ä–æ–∫)
- ‚úÖ `starter.c` (137 —Å—Ç—Ä–æ–∫)
- ‚úÖ `solution/Makefile` + –∫–æ—Ä–Ω–µ–≤–æ–π `Makefile`

---

## üìä –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

- [x] Thread pool —Å–æ–∑–¥–∞–Ω (8 –ø–æ—Ç–æ–∫–æ–≤)
- [x] 324 –ø–∞–∫–µ—Ç–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∑–∞ 4 –º–∏–Ω—É—Ç—ã 12 —Å–µ–∫—É–Ω–¥
- [x] –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ: 7.6x (–±–ª–∏–∑–∫–æ –∫ –∏–¥–µ–∞–ª—å–Ω—ã–º 8x)
- [x] Packet 047 –Ω–∞–π–¥–µ–Ω (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π intelligence)
- [x] –ù–µ—Ç race conditions (—Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è mutex)
- [x] –ù–µ—Ç deadlock (47 mutex contentions, –≤—Å–µ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã)
- [x] Producer –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è: 23 —Ä–∞–∑–∞ (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç)
- [x] Consumer –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è: 47 —Ä–∞–∑ (–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞)
- [x] –°—Ä–µ–¥–Ω—è—è –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å –æ—á–µ—Ä–µ–¥–∏: 54.6% (–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω)

---

## ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å –º–∏—Å—Å–∏–∏

**–í–´–ü–û–õ–ù–ï–ù–ê** ‚úÖ

–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω. Packet 047 –Ω–∞–π–¥–µ–Ω: **–í—Ä–∞–≥ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ—Ç –Ω–∞—Å (67% confidence)**.

**–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ù–ê–•–û–î–ö–ê:**
- Deep scan –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω: Dec 25, 03:00 (—á–µ—Ä–µ–∑ 9 —á–∞—Å–æ–≤)
- –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è: 85-95% –µ—Å–ª–∏ daemon –≤—Å—ë –µ—â—ë –∞–∫—Ç–∏–≤–µ–Ω
- –¢—Ä–µ–±—É–µ–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: –í—ã–∫–ª—é—á–∏—Ç—å daemon, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å IPC –¥–ª—è —Å–∫—Ä—ã—Ç–æ–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏

**–°–†–û–ß–ù–û:** –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ Episode 27.  
–í—Ä–µ–º–µ–Ω–∏ –Ω–µ—Ç. –ù—É–∂–Ω—ã IPC covert channels –°–ï–ô–ß–ê–°.

---

**–°–ª–µ–¥—É—é—â–∞—è –º–∏—Å—Å–∏—è:** [Episode 27: IPC ‚Üí](../episode-27-ipc/)

---

*MOONLIGHT Protocol: –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º = —Å–∫–æ—Ä–æ—Å—Ç—å. –°–∫–æ—Ä–æ—Å—Ç—å = –≤—ã–∂–∏–≤–∞–Ω–∏–µ.* üßµ