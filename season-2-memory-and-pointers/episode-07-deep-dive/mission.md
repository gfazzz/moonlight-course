# –ú–∏—Å—Å–∏—è: "–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∑–∞–≥—Ä—É–∑—á–∏–∫"

## üéØ –¶–µ–ª—å

–°–æ–∑–¥–∞—Ç—å `dynamic_loader` ‚Äî —Å–∏—Å—Ç–µ–º—É –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º –ø–∞–º—è—Ç–∏.

## üìã –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

- –§–∞–π–ª: `archive.dat` (–±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞: HEADER + BLOCKS (–ø–µ—Ä–µ–º–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Ä–∞–∑–º–µ—Ä)

### –§–æ—Ä–º–∞—Ç –∞—Ä—Ö–∏–≤–∞

**HEADER** (8 –±–∞–π—Ç):
```c
typedef struct {
    char magic[4];        // "MOON" (0x4D 0x4F 0x4F 0x4E)
    uint16_t version;     // –í–µ—Ä—Å–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ (1)
    uint16_t block_count; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤
} Header;
```

**BLOCK** (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä):
```c
typedef struct {
    uint8_t type;         // –¢–∏–ø –±–ª–æ–∫–∞ (1 –±–∞–π—Ç)
    uint32_t size;        // –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö (4 –±–∞–π—Ç–∞)
    uint8_t *data;        // –î–∞–Ω–Ω—ã–µ (size –±–∞–π—Ç)
} Block;
```

**–¢–∏–ø—ã –±–ª–æ–∫–æ–≤**:
- `0x01` ‚Äî TEXT: —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–º–æ–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ –∫–∞–∫ —Å—Ç—Ä–æ–∫—É)
- `0x02` ‚Äî BINARY: –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ –±–∞–π—Ç—ã (–≤—ã–≤–µ—Å—Ç–∏ hex dump)
- `0x03` ‚Äî COMPRESSED: —Å–∂–∞—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–µ —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º, —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä)

### –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

```
=== DYNAMIC LOADER ===
Archive: archive.dat
Magic: MOON
Version: 1
Blocks: N

Loading blocks...
[1/N] TEXT (XX bytes) loaded
[2/N] BINARY (XXX bytes) loaded
...

Block #1 (TEXT):
"Text content here..."

Block #2 (BINARY):
00000000: 48 65 6C 6C 6F 20 57 6F  72 6C 64 00 00 00 00 00  |Hello World.....|
...

Total memory allocated: XXXX bytes
Freeing memory...
Memory freed successfully. No leaks!
```

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

1. **–ß—Ç–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞**:
   - –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª
   - –ü—Ä–æ—á–∏—Ç–∞—Ç—å –∏ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å magic ("MOON")
   - –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤

2. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –±–ª–æ–∫–æ–≤**:
   - –í—ã–¥–µ–ª–∏—Ç—å –º–∞—Å—Å–∏–≤ Block'–æ–≤ (malloc)
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞:
     * –ü—Ä–æ—á–∏—Ç–∞—Ç—å type –∏ size
     * –í—ã–¥–µ–ª–∏—Ç—å –ø–∞–º—è—Ç—å –ø–æ–¥ data (malloc)
     * –ü—Ä–æ—á–∏—Ç–∞—Ç—å data

3. **–í—ã–≤–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ**:
   - TEXT: –≤—ã–≤–µ—Å—Ç–∏ –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
   - BINARY: hex dump (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑–º–µ—Ä)
   - COMPRESSED: —Ç–æ–ª—å–∫–æ —Ä–∞–∑–º–µ—Ä –∏ —Ç–∏–ø

4. **–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏**:
   - –û—Å–≤–æ–±–æ–¥–∏—Ç—å data –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞
   - –û—Å–≤–æ–±–æ–¥–∏—Ç—å –º–∞—Å—Å–∏–≤ –±–ª–æ–∫–æ–≤
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —É—Ç–µ—á–µ–∫

---

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

```c
// –ß—Ç–µ–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
Header* read_header(FILE *f);

// –ß—Ç–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –±–ª–æ–∫–∞ (—Å malloc –¥–ª—è data!)
Block* read_block(FILE *f);

// –í—ã–≤–æ–¥ –±–ª–æ–∫–∞ (—Ä–∞–∑–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤)
void print_block(Block *block, int index);

// –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –±–ª–æ–∫–∞ (free data!)
void free_block(Block *block);

// –ü–æ–¥—Å—á—ë—Ç –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏
size_t calculate_total_memory(Block *blocks, int count);
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ main()

```c
int main(int argc, char *argv[]) {
    // 1. –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª
    // 2. –ü—Ä–æ—á–∏—Ç–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫
    // 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å magic
    // 4. –í—ã–¥–µ–ª–∏—Ç—å –º–∞—Å—Å–∏–≤ –±–ª–æ–∫–æ–≤
    // 5. –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –±–ª–æ–∫–∏
    // 6. –í—ã–≤–µ—Å—Ç–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    // 7. –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –ø–∞–º—è—Ç—å
    // 8. –û—Å–≤–æ–±–æ–¥–∏—Ç—å –≤—Å—ë
    // 9. –í—ã–≤–µ—Å—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    return 0;
}
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

- [ ] –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
- [ ] –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ —á–∏—Ç–∞–µ—Ç –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫
- [ ] –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤—ã–¥–µ–ª—è–µ—Ç –ø–∞–º—è—Ç—å –¥–ª—è –±–ª–æ–∫–æ–≤
- [ ] –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤—ã–¥–µ–ª—è–µ—Ç –ø–∞–º—è—Ç—å –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤
- [ ] –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Ç–∏–ø—ã –±–ª–æ–∫–æ–≤
- [ ] –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –≤—Å—é –ø–∞–º—è—Ç—å
- [ ] –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ –≤—ã–∑–æ–≤—ã malloc –Ω–∞ NULL
- [ ] –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è/—á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞
- [ ] Valgrind –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—Ç–µ—á–µ–∫
- [ ] `make test` –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ

---

## üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏

<details>
<summary>–ö–∞–∫ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å magic?</summary>

```c
Header* read_header(FILE *f) {
    Header *h = malloc(sizeof(Header));
    if (!h) return NULL;
    
    fread(h, sizeof(Header), 1, f);
    
    if (memcmp(h->magic, "MOON", 4) != 0) {
        fprintf(stderr, "Invalid magic number!\n");
        free(h);
        return NULL;
    }
    
    return h;
}
```
</details>

<details>
<summary>–ö–∞–∫ —á–∏—Ç–∞—Ç—å –±–ª–æ–∫?</summary>

```c
Block* read_block(FILE *f) {
    Block *b = malloc(sizeof(Block));
    if (!b) return NULL;
    
    // –ß–∏—Ç–∞–µ–º type –∏ size
    if (fread(&b->type, 1, 1, f) != 1 ||
        fread(&b->size, sizeof(uint32_t), 1, f) != 1) {
        free(b);
        return NULL;
    }
    
    // –í—ã–¥–µ–ª—è–µ–º –ø–∞–º—è—Ç—å –ø–æ–¥ –¥–∞–Ω–Ω—ã–µ
    b->data = malloc(b->size);
    if (!b->data) {
        free(b);
        return NULL;
    }
    
    // –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    if (fread(b->data, 1, b->size, f) != b->size) {
        free(b->data);
        free(b);
        return NULL;
    }
    
    return b;
}
```
</details>

<details>
<summary>–ö–∞–∫ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –≤—Å–µ?</summary>

```c
// –ü–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω!

// 1. –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞
for (int i = 0; i < block_count; i++) {
    if (blocks[i].data) {
        free(blocks[i].data);
        blocks[i].data = NULL;
    }
}

// 2. –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –±–ª–æ–∫–æ–≤
free(blocks);
blocks = NULL;

// 3. –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
free(header);
header = NULL;
```
</details>

<details>
<summary>–ö–∞–∫ –ø–æ–¥—Å—á–∏—Ç–∞—Ç—å –ø–∞–º—è—Ç—å?</summary>

```c
size_t total = sizeof(Header);  // –ó–∞–≥–æ–ª–æ–≤–æ–∫
total += block_count * sizeof(Block);  // –ú–∞—Å—Å–∏–≤ –±–ª–æ–∫–æ–≤

for (int i = 0; i < block_count; i++) {
    total += blocks[i].size;  // –î–∞–Ω–Ω—ã–µ –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞
}

printf("Total allocated: %zu bytes\n", total);
```
</details>

---

**–£–¥–∞—á–∏, –∞–≥–µ–Ω—Ç!** üïµÔ∏è‚Äç‚ôÇÔ∏è
