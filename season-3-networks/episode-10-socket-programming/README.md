# Episode 10: "Socket Programming" ๐

> *"Every connection is a handshake. Master the protocol, control the channel."*

---

## ๐ฌ BRIEFING

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะะะะะฆะะฏ: Safe House (ะฝะตะธะทะฒะตััะฝัะน ะฐะดัะตั), ะะพัะบะฒะฐ        โ
โ  ะะะะะฏ:   09:30, ััะตะดะฐ, 1 ะพะบััะฑัั                       โ
โ  ะกะขะะขะฃะก:  ๐ด SERVER CONNECTION CRITICAL โ DEADLINE!      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

ะะพัะปะต ะฐะฝะฐะปะธะทะฐ `addresses.txt` ะฒั ะฝะฐัะปะธ **ะฟะตัะฒัะน ัะทะตะป**: `203.0.113.42:31337`.  
GPS-ะบะพะพัะดะธะฝะฐัั ัะฐััะธััะพะฒะฐะฝั: ะัะฐัะฝะฐั ะฟะปะพัะฐะดั โ ัะพัะบะฐ ะฒัััะตัะธ.

**ะะพ ัะตะฟะตัั ะฝัะถะฝะพ ะะะะะะฎะงะะขะฌะกะฏ ะบ ัะตัะฒะตัั V.**

ะ 09:28 ะฟัะธัะพะดะธั ััะพัะฝะฐั ะธะฝััััะบัะธั:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  FROM: V. (ENCRYPTED CHANNEL)               โ
โ  TIME: 09:28:14 UTC                         โ
โ  PRIORITY: ๐ด CRITICAL                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                             โ
โ  ะะดัะตั ะฝะฐะนะดะตะฝ. ะขะตะฟะตัั โ ะฟะพะดะบะปััะตะฝะธะต.        โ
โ                                             โ
โ  ะกะตัะฒะตั: 203.0.113.42:31337                 โ
โ  ะัะพัะพะบะพะป: TCP                              โ
โ  ะััะตะฝัะธัะธะบะฐัะธั: Challenge-Response         โ
โ                                             โ
โ  โ๏ธ ะะะะขะะงะะ:                               โ
โ  ะกะตัะฒะตั ัะฐะผะพัะฝะธััะพะถะธััั ัะตัะตะท 5 ัะฐัะพะฒ!      โ
โ  Deadline: 14:30 UTC                        โ
โ                                             โ
โ  ะัะธัะธะฝะฐ: ะะธัะบ ะบะพะผะฟัะพะผะตัะฐัะธะธ.               โ
โ  ะัะตัะปะตะดะพะฒะฐัะตะปะธ Z. ัะบะฐะฝะธัััั ัะตัั.          โ
โ                                             โ
โ  ะจะฐะณะธ:                                      โ
โ  1. ะะพะดะบะปััะธัััั ัะตัะตะท socket()             โ
โ  2. ะัะฟัะฐะฒะธัั ะบะพะผะฐะฝะดั: AUTH <key>           โ
โ  3. ะะพะปััะธัั challenge (ัะธัะปะพ)              โ
โ  4. ะัะฟัะฐะฒะธัั response (XOR ั ะบะปััะพะผ)       โ
โ  5. ะะพะปััะธัั ะบะพะพัะดะธะฝะฐัั ัะปะตะดัััะตะณะพ ัะทะปะฐ     โ
โ                                             โ
โ  ะะปัั ะดะปั AUTH: MOONLIGHT2024               โ
โ                                             โ
โ  ะะพัะพัะพะฟะธัั. ะัะตะผั ะธะดัั.                    โ
โ  โ V.                                       โ
โ                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### โฑ๏ธ ะัะตะผะตะฝะฝะฐั ะปะธะฝะธั ัะพะฑััะธะน

```
09:28 โ ๐ง ะะฝััััะบัะธั ะพั V.: ะฟะพะดะบะปััะธัััั ะบ ัะตัะฒะตัั
        โฐ DEADLINE: 5 ัะฐัะพะฒ ะดะพ ะฐะฒัะพัะดะฐะปะตะฝะธั (14:30)
        
09:30 โ ๐ง ะะฐัะฐะปะพ ัะฐะทัะฐะฑะพัะบะธ TCP-ะบะปะธะตะฝัะฐ
        ะะทััะตะฝะธะต socket API (socket, connect, send, recv)
        
10:15 โ โก ะะะะะะฏ ะะะะซะขะะ ะฟะพะดะบะปััะตะฝะธั
        $ ./moonlight_client 203.0.113.42 31337
        
10:16 โ ๐ฅ CONNECTION REFUSED!
        ๐จ ะะฑะฝะฐััะถะตะฝะพ: ะกะตัะฒะตั ะฟะพะด DDoS-ะฐัะฐะบะพะน!
        ะขััััะธ SYN-ะฟะฐะบะตัะพะฒ ะพั 185.220.101.0/24
        (ะัะตัะปะตะดะพะฒะฐัะตะปะธ Z. ะฐัะฐะบััั ัะตัะฒะตั!)
        
10:17 โ ๐ SMS ะพั V.:
        "ะะฝะธ ะฟััะฐัััั ะทะฐะฑะปะพะบะธัะพะฒะฐัั ะดะพัััะฟ.
         ะะพะฟัะพะฑัะน ัะฝะพะฒะฐ ัะตัะตะท 30 ะผะธะฝัั.
         ะัะฐะบั ะพััะฐะถะฐั."
         
10:47 โ ๐ ะะขะะะะฏ ะะะะซะขะะ ะฟะพะดะบะปััะตะฝะธั
        connect() ััะฟะตัะตะฝ!
        โ TCP handshake: SYN โ SYN-ACK โ ACK
        
10:48 โ ๐ ะััะตะฝัะธัะธะบะฐัะธั ะฝะฐัะฐัะฐ
        โ AUTH MOONLIGHT2024
        โ CHALLENGE 0x7FA3B2C1
        
        ๐ก ะะฑะฝะฐััะถะตะฝะธะต: Challenge ะผะตะฝัะตััั ะบะฐะถะดัะต 60 ัะตะบ!
        (ะะพะฟะพะปะฝะธัะตะปัะฝะฐั ะทะฐัะธัะฐ ะพั ะฟะตัะตัะฒะฐัะฐ)
        
10:49 โ ๐งฎ ะััะธัะปะตะฝะธะต response
        hash("MOONLIGHT2024") = 0x4F2A1B3C
        response = 0x7FA3B2C1 XOR 0x4F2A1B3C = 0x3089A9FD
        
10:50 โ โ ะัะฟัะฐะฒะบะฐ response
        โ RESPONSE 0x3089A9FD
        
10:51 โ ๐ฏ ACCESS GRANTED!
        โ "ะกะปะตะดัััะธะน ัะทะตะป: 10.0.0.1:4433"
        โ "ะัะพัะพะบะพะป: Encrypted TCP"
        โ "Episode 11: Packet Analysis"
        
        โฑ๏ธ ะัะตะผั ะดะพ deadline: 3 ัะฐัะฐ 39 ะผะธะฝัั
        โ ะฃัะฟะตะปะธ ะฒะพะฒัะตะผั!
```

**ะงัะพ ะฒั ะฟะพะฝะธะผะฐะตัะต:**
- ะัะถะฝะพ ะฝะฐะฟะธัะฐัั **TCP-ะบะปะธะตะฝั** ะฝะฐ C
- ะัะฟะพะปัะทะพะฒะฐัั **socket API**: `socket()`, `connect()`, `send()`, `recv()`
- ะะตะฐะปะธะทะพะฒะฐัั **challenge-response** ะฐััะตะฝัะธัะธะบะฐัะธั
- **ะัะตะผั ะพะณัะฐะฝะธัะตะฝะพ** โ ัะตัะฒะตั ัะฐะผะพัะฝะธััะพะถะธััั!
- **ะัะตัะปะตะดะพะฒะฐัะตะปะธ ะฐะบัะธะฒะฝั** โ DDoS-ะฐัะฐะบะฐ ะฝะฐ ัะตัะฒะตั
- Challenge **ะดะธะฝะฐะผะธัะตัะบะธะน** โ ะทะฐัะธัะฐ ะพั replay-ะฐัะฐะบ

ะญัะพ **ะฟะตัะฒะพะต ัะตะฐะปัะฝะพะต ัะตัะตะฒะพะต ัะพะตะดะธะฝะตะฝะธะต ะฟะพะด ะดะฐะฒะปะตะฝะธะตะผ**. ะะพัะฐ ััะฐัั ะผะฐััะตัะพะผ ัะพะบะตัะพะฒ.

### ๐ฏ ะะะะะงะ

ะกะพะทะดะฐัั **`moonlight_client`** โ TCP-ะบะปะธะตะฝั ะดะปั ัะฒัะทะธ ั ัะตัะฒะตัะพะผ:
1. โ ะะพะดะบะปััะตะฝะธะต ะบ ัะตัะฒะตัั ะฟะพ TCP
2. โ ะัะฟัะฐะฒะบะฐ ะบะพะผะฐะฝะดั AUTH ั ะบะปััะพะผ
3. โ ะะพะปััะตะฝะธะต challenge ะพั ัะตัะฒะตัะฐ
4. โ ะััะธัะปะตะฝะธะต response (XOR challenge ั ะบะปััะพะผ)
5. โ ะะพะปััะตะฝะธะต ัะตะบัะตัะฝะพะณะพ ัะพะพะฑัะตะฝะธั
6. โ ะะพััะตะบัะฝะพะต ะทะฐะบัััะธะต ัะพะตะดะธะฝะตะฝะธั

**ะกะปะพะถะฝะพััั:** ๐ก Medium  
**ะะพะฒัะต ะฝะฐะฒัะบะธ:** Socket programming, TCP client, challenge-response protocol

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  [!] ะะะะะะะะ:                               โ
โ  ะญัะพ ะฒะฐั ะฟะตัะฒัะน TCP-ะบะปะธะตะฝั.                  โ
โ  ะะฐะถะดัะน ะฒัะทะพะฒ socket API โ ัะฐะณ ะฒ ัะตัั.       โ
โ  ะัะธะฑะบะฐ = ัะฐะทััะฒ ัะพะตะดะธะฝะตะฝะธั.                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ะขะตะพัะธั: ะกะพะบะตัั ะฒ C

### ๐ก ะะฐัะตะผ ััะพ ะฝัะถะฝะพ ะฒ ัะตะฐะปัะฝะพััะธ?

**ะกะพะบะตัั** โ ะพัะฝะพะฒะฐ ะฒัะตั ัะตัะตะฒัั ะฟัะธะปะพะถะตะฝะธะน:
- ๐ **ะะตะฑ**: ะฑัะฐัะทะตัั, ัะตัะฒะตัั (HTTP/HTTPS)
- ๐ง **Email**: SMTP, IMAP, POP3
- ๐ฌ **ะะตััะตะฝะดะถะตัั**: WhatsApp, Telegram
- ๐ฎ **ะะณัั**: ะผะฝะพะณะพะฟะพะปัะทะพะฒะฐัะตะปััะบะธะต ะพะฝะปะฐะนะฝ-ะธะณัั
- ๐ **ะะตะทะพะฟะฐัะฝะพััั**: VPN, SSH, SSL/TLS

**ะะตะท ัะพะบะตัะพะฒ ะฝะตั ะธะฝัะตัะฝะตัะฐ.**

---

### 1. ะงัะพ ัะฐะบะพะต ัะพะบะตั?

**ะกะพะบะตั** โ ััะพ:
- **ะะพะฝะตัะฝะฐั ัะพัะบะฐ** ะดะปั ะพัะฟัะฐะฒะบะธ/ะฟะพะปััะตะฝะธั ะดะฐะฝะฝัั
- **ะคะฐะนะปะพะฒัะน ะดะตัะบัะธะฟัะพั** (ะบะฐะบ ัะฐะนะป, ะฝะพ ะดะปั ัะตัะธ)
- **ะะฑัััะฐะบัะธั** ะฝะฐะด TCP/IP

```c
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>

// ะกะพะทะดะฐะฝะธะต ัะพะบะตัะฐ
int sockfd = socket(AF_INET, SOCK_STREAM, 0);  // TCP
// AF_INET   - IPv4
// SOCK_STREAM - TCP (ะฝะฐะดะตะถะฝัะน, ั ัััะฐะฝะพะฒะบะพะน ัะพะตะดะธะฝะตะฝะธั)
// 0 - ะฟัะพัะพะบะพะป ะฟะพ ัะผะพะปัะฐะฝะธั

// ะะปะธ UDP:
int udp_fd = socket(AF_INET, SOCK_DGRAM, 0);   // UDP
// SOCK_DGRAM - UDP (ะฝะตะฝะฐะดะตะถะฝัะน, ะฑะตะท ัะพะตะดะธะฝะตะฝะธั)
```

**ะะฝะฐะปะพะณะธั**: ะกะพะบะตั โ ััะพ "ัะตะปะตัะพะฝ". TCP โ ะทะฒะพะฝะพะบ (ั ัััะฐะฝะพะฒะบะพะน ัะฒัะทะธ). UDP โ SMS (ะพัะฟัะฐะฒะธะป ะธ ะทะฐะฑัะป).

---

### 2. ะกัััะบัััะฐ ะฐะดัะตัะฐ

```c
struct sockaddr_in {
    sa_family_t    sin_family;  // AF_INET (IPv4)
    in_port_t      sin_port;    // ะะพัั (network byte order!)
    struct in_addr sin_addr;    // IP ะฐะดัะตั
    char           sin_zero[8]; // Padding (ะพะฑะฝัะปะธัั!)
};

// ะัะธะผะตั ะทะฐะฟะพะปะฝะตะฝะธั:
struct sockaddr_in server_addr;
memset(&server_addr, 0, sizeof(server_addr));  // ะะฑะฝัะปะธัั!

server_addr.sin_family = AF_INET;
server_addr.sin_port = htons(31337);  // Host to Network Short
inet_pton(AF_INET, "203.0.113.42", &server_addr.sin_addr);
```

**ะะฐะถะฝะพ**: ะัะตะณะดะฐ ะธัะฟะพะปัะทัะนัะต `htons()` ะดะปั ะฟะพััะพะฒ! (Byte order!)

---

### 3. TCP ะะปะธะตะฝั (ะฟะพัะฐะณะพะฒะพ)

#### ะจะฐะณ 1: ะกะพะทะดะฐัั ัะพะบะตั

```c
int sockfd = socket(AF_INET, SOCK_STREAM, 0);
if (sockfd < 0) {
    perror("socket failed");
    return 1;
}
```

#### ะจะฐะณ 2: ะะฐัััะพะธัั ะฐะดัะตั ัะตัะฒะตัะฐ

```c
struct sockaddr_in server_addr;
memset(&server_addr, 0, sizeof(server_addr));

server_addr.sin_family = AF_INET;
server_addr.sin_port = htons(31337);
inet_pton(AF_INET, "203.0.113.42", &server_addr.sin_addr);
```

#### ะจะฐะณ 3: ะะพะดะบะปััะธัััั

```c
if (connect(sockfd, (struct sockaddr*)&server_addr, sizeof(server_addr)) < 0) {
    perror("connect failed");
    close(sockfd);
    return 1;
}

printf("Connected to server!\n");
```

**ะะพะผะตะฝั connect()**: ะฟัะพะธััะพะดะธั **TCP handshake** (SYN, SYN-ACK, ACK).

#### ะจะฐะณ 4: ะัะฟัะฐะฒะธัั ะดะฐะฝะฝัะต

```c
char message[] = "AUTH MOONLIGHT2024\n";
ssize_t sent = send(sockfd, message, strlen(message), 0);
if (sent < 0) {
    perror("send failed");
}
```

**ะะฐะถะฝะพ**: `send()` ะฒะพะทะฒัะฐัะฐะตั ะบะพะปะธัะตััะฒะพ ะพัะฟัะฐะฒะปะตะฝะฝัั ะฑะฐะนัะพะฒ (ะผะพะถะตั ะฑััั ะผะตะฝััะต ะทะฐะฟัะพัะตะฝะฝะพะณะพ!).

#### ะจะฐะณ 5: ะะพะปััะธัั ะดะฐะฝะฝัะต

```c
char buffer[1024];
memset(buffer, 0, sizeof(buffer));

ssize_t received = recv(sockfd, buffer, sizeof(buffer) - 1, 0);
if (received < 0) {
    perror("recv failed");
} else if (received == 0) {
    printf("Server closed connection\n");
} else {
    printf("Received: %s\n", buffer);
}
```

**ะัะพะฑะตะฝะฝะพััะธ `recv()`**:
- ะะพะทะฒัะฐัะฐะตั 0 โ ัะตัะฒะตั ะทะฐะบััะป ัะพะตะดะธะฝะตะฝะธะต
- ะะพะทะฒัะฐัะฐะตั -1 โ ะพัะธะฑะบะฐ
- ะะพะทะฒัะฐัะฐะตั N > 0 โ ะฟะพะปััะตะฝะพ N ะฑะฐะนัะพะฒ

#### ะจะฐะณ 6: ะะฐะบัััั ัะพะบะตั

```c
close(sockfd);
```

**ะะฐะถะฝะพ**: ะัะตะณะดะฐ ะทะฐะบััะฒะฐะนัะต ัะพะบะตัั! (ะฃัะตัะบะฐ ะดะตัะบัะธะฟัะพัะพะฒ!)

---

### 4. TCP ะกะตัะฒะตั (ะดะปั ะฟะพะฝะธะผะฐะฝะธั)

```c
// 1. ะกะพะทะดะฐัั ัะพะบะตั
int server_fd = socket(AF_INET, SOCK_STREAM, 0);

// 2. ะะฟัะธะธ ัะพะบะตัะฐ (ะฟะตัะตะธัะฟะพะปัะทะพะฒะฐะฝะธะต ะฐะดัะตัะฐ)
int opt = 1;
setsockopt(server_fd, SOL_SOCKET, SO_REUSEADDR, &opt, sizeof(opt));

// 3. ะัะธะฒัะทะฐัั ะบ ะฐะดัะตัั
struct sockaddr_in addr;
addr.sin_family = AF_INET;
addr.sin_port = htons(8080);
addr.sin_addr.s_addr = INADDR_ANY;  // ะัะฑะพะน ะธะฝัะตััะตะนั

bind(server_fd, (struct sockaddr*)&addr, sizeof(addr));

// 4. ะกะปััะฐัั
listen(server_fd, 5);  // Backlog = 5 (ะพัะตัะตะดั ะฟะพะดะบะปััะตะฝะธะน)

// 5. ะัะธะฝััั ะบะปะธะตะฝัะฐ
struct sockaddr_in client_addr;
socklen_t client_len = sizeof(client_addr);
int client_fd = accept(server_fd, (struct sockaddr*)&client_addr, &client_len);

// 6. ะะฑะผะตะฝ ะดะฐะฝะฝัะผะธ
char buffer[1024];
recv(client_fd, buffer, sizeof(buffer), 0);
send(client_fd, "Response", 8, 0);

// 7. ะะฐะบัััั
close(client_fd);
close(server_fd);
```

---

### 5. UDP (ะดะปั ััะฐะฒะฝะตะฝะธั)

```c
// ะะปะธะตะฝั UDP (ะฑะตะท connect!)
int sockfd = socket(AF_INET, SOCK_DGRAM, 0);

struct sockaddr_in server_addr;
// ... ะฝะฐัััะพะนะบะฐ ะฐะดัะตัะฐ ...

// ะัะฟัะฐะฒะธัั (ัะบะฐะทัะฒะฐะตะผ ะฐะดัะตั ะบะฐะถะดัะน ัะฐะท!)
sendto(sockfd, "Hello", 5, 0, 
       (struct sockaddr*)&server_addr, sizeof(server_addr));

// ะะพะปััะธัั
char buffer[1024];
socklen_t addr_len = sizeof(server_addr);
recvfrom(sockfd, buffer, sizeof(buffer), 0,
         (struct sockaddr*)&server_addr, &addr_len);

close(sockfd);
```

**ะะฐะทะฝะธัะฐ TCP vs UDP**:
- TCP: `connect()` โ `send()` / `recv()`
- UDP: `sendto()` / `recvfrom()` (ะฑะตะท connect)

---

### 6. ๐ก ะะะขะะคะะะ: TCP = ะขะตะปะตัะพะฝะฝัะน ะทะฒะพะฝะพะบ

ะัััะธะน ัะฟะพัะพะฑ ะฟะพะฝััั ัะพะบะตัั โ **ะฟัะตะดััะฐะฒะธัั ะธั ะบะฐะบ ัะตะปะตัะพะฝะฝัะน ะทะฒะพะฝะพะบ**:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ TCP ะกะะะะะะะะะ โ ะขะตะปะตัะพะฝะฝัะน ะทะฒะพะฝะพะบ                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
โ                                                            โ
โ  socket() = ะะฃะะะขะฌ ะขะะะะคะะ                                 โ
โ  โโโโโโโโโโโโ                                              โ
โ  โ   ๐ฑ     โ  "ะขะตะฟะตัั ั ะผะตะฝั ะตััั ััััะพะนััะฒะพ"            โ
โ  โโโโโโโโโโโโ  ะะพ ะตัั ะฝะธะบะพะผั ะฝะต ะทะฒะพะฝะธะป!                   โ
โ                                                            โ
โ  connect() = ะะะะะะะะขะฌ ะะ ะะะะะ                            โ
โ  ๐ฑ โ ๐  "ะะฐะฑะธัะฐั 203.0.113.42:31337..."                 โ
โ                                                            โ
โ  TCP 3-WAY HANDSHAKE = ะฃััะฐะฝะพะฒะบะฐ ัะฒัะทะธ:                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ               โ
โ  โ ะะซ โ ะกะะะะะ:    SYN                    โ               โ
โ  โ "ะะปะปะพ, ะผะพะถะฝะพ ะะธะบัะพัะฐ?"                 โ               โ
โ  โ                                        โ               โ
โ  โ ะกะะะะะ โ ะะซ:    SYN-ACK                โ               โ
โ  โ "ะะฐ, ัะปััะฐั!"                          โ               โ
โ  โ                                        โ               โ
โ  โ ะะซ โ ะกะะะะะ:    ACK                    โ               โ
โ  โ "ะะบะตะน, ะฝะฐัะธะฝะฐั ัะฐะทะณะพะฒะพั"               โ               โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ               โ
โ  โ ะกะะะะะะะะะ ะฃะกะขะะะะะะะะ!                                โ
โ                                                            โ
โ  send() = ะะะะะะะขะฌ ะ ะขะะฃะะะฃ                                โ
โ  ๐ฑ "AUTH MOONLIGHT2024" โ ๐ก                              โ
โ  ะั ะฟะตัะตะดะฐััะต ัะพะพะฑัะตะฝะธะต                                    โ
โ                                                            โ
โ  recv() = ะกะะฃะจะะขะฌ ะะขะะะข                                    โ
โ  ๐ก "CHALLENGE 0x12345678" โ ๐ฑ                            โ
โ  ะั ะฟะพะปััะฐะตัะต ะพัะฒะตั                                        โ
โ                                                            โ
โ  close() = ะะะะะะะขะฌ ะขะะฃะะะฃ                                 โ
โ  ๐ฑ โ๏ธ  "ะะฐะทะณะพะฒะพั ะพะบะพะฝัะตะฝ"                                 โ
โ  ะัะฟัะฐะฒะปัะตััั FIN โ FIN-ACK (ะฒะตะถะปะธะฒะพะต ะทะฐะฒะตััะตะฝะธะต)         โ
โ                                                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ASCII-ะดะธะฐะณัะฐะผะผะฐ TCP Handshake:**

```
     ะะะะะะข (ะะซ)                    ะกะะะะะ (V. ะฝะฐ 31337)
         ๐ฑ                                ๐ฅ๏ธ
          โ                                 โ
    socket()                          socket()
    bind()                            bind()
    connect() โโโโโโโโโโโโโโโโโโโโโโ  listen()
          โ                                 โ
          โ  โโโโ SYN (seq=1000) โโโโโโโโ> โ
          โ  "ะัะธะฒะตั! ะฅะพัั ะฟะพะดะบะปััะธัััั!"   โ
          โ                            accept()
          โ                                 โ
          โ  <โโโโ SYN-ACK โโโโโโโโโโโโโโโโ โ
          โ  (seq=5000, ack=1001)           โ
          โ  "ะะบะตะน! ะฏ ะณะพัะพะฒ!"               โ
          โ                                 โ
          โ  โโโโ ACK (ack=5001) โโโโโโโโ> โ
          โ  "ะัะปะธัะฝะพ! ะะฐัะธะฝะฐะตะผ!"           โ
          โ                                 โ
          โ  โโโ CONNECTED โโโโโโโโโโโโโโโโ โ
          โ                                 โ
    send()                              recv()
          โ  โโโโ "AUTH MOONLIGHT2024" โโ> โ
          โ                                 โ
          โ                            send()
          โ  <โโโโ "CHALLENGE 0x..." โโโโโโ โ
    recv()โ                                 โ
          โ                                 โ
    send()                              recv()
          โ  โโโโ "RESPONSE 0x..." โโโโโโ> โ
          โ                                 โ
          โ                            send()
          โ  <โโโโ "ACCESS GRANTED" โโโโโโโโ โ
    recv()โ                                 โ
          โ                                 โ
    close()                            close()
          โ  โโโโ FIN โโโโโโโโโโโโโโโโโโโโโ> โ
          โ  <โโโโ FIN-ACK โโโโโโโโโโโโโโโโโ โ
          โ  โโโโ ACK โโโโโโโโโโโโโโโโโโโโโ> โ
          โ                                 โ
          โ๏ธ                                  โ๏ธ
    ะกะพะตะดะธะฝะตะฝะธะต ะทะฐะบัััะพ          ะกะพะตะดะธะฝะตะฝะธะต ะทะฐะบัััะพ
```

**ะขะธะฟะธัะฝัะต ะพัะธะฑะบะธ (ะฐะฝะฐะปะพะณะธั ั ัะตะปะตัะพะฝะพะผ):**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะะจะะะะ                   โ  ะขะะะะคะะะะะฏ ะะะะะะะะฏ            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
โ  ECONNREFUSED             โ  "ะะฑะพะฝะตะฝั ะฝะตะดะพัััะฟะตะฝ"          โ
โ  (ัะตัะฒะตั ะฝะต ะทะฐะฟััะตะฝ)      โ  ะขะตะปะตัะพะฝ ะฒัะบะปััะตะฝ              โ
โ                           โ                                โ
โ  ETIMEDOUT                โ  "ะะตั ะพัะฒะตัะฐ"                  โ
โ  (ัะตัะฒะตั ะฝะต ะพัะฒะตัะฐะตั)     โ  ะะฒะพะฝะธัะต, ะฝะพ ะฝะธะบัะพ ะฝะต ะฑะตััั    โ
โ                           โ                                โ
โ  ECONNRESET               โ  "ะกะฑัะพัะธะปะธ ะทะฒะพะฝะพะบ"             โ
โ  (ัะตัะฒะตั ัะฐะทะพัะฒะฐะป ัะฒัะทั)  โ  ะะพะปะพะถะธะปะธ ัััะฑะบั ะฒ ะปะธัะพ        โ
โ                           โ                                โ
โ  ENETUNREACH              โ  "ะกะตัั ะฝะตะดะพัััะฟะฝะฐ"             โ
โ  (ะฝะตั ะผะฐัััััะฐ)           โ  ะะตั ัะฒัะทะธ ะฒะพะพะฑัะต              โ
โ                           โ                                โ
โ  EAGAIN / EWOULDBLOCK     โ  "ะะธะฝะธั ะทะฐะฝััะฐ"                โ
โ  (ะฝะตะฑะปะพะบะธััััะธะน ัะตะถะธะผ)    โ  ะะพะฟัะพะฑัะนัะต ะฟะพะทะถะต              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะัะฐะบัะธัะตัะบะธะน ะฟัะธะผะตั ะฒ ะบะพะดะต:**

```c
// ะจะะ 1: ะัะฟะธัั ัะตะปะตัะพะฝ
int sockfd = socket(AF_INET, SOCK_STREAM, 0);
if (sockfd < 0) {
    perror("ะะต ะผะพะณั ัะพะทะดะฐัั ัะพะบะตั (ะบัะฟะธัั ัะตะปะตัะพะฝ)");
    return 1;
}

// ะจะะ 2: ะะฐะฑัะฐัั ะฝะพะผะตั (ะฝะฐัััะพะธัั ะฐะดัะตั)
struct sockaddr_in server_addr;
memset(&server_addr, 0, sizeof(server_addr));
server_addr.sin_family = AF_INET;
server_addr.sin_port = htons(31337);  // ะะพัั โ ะบะฐะบ ะดะพะฑะฐะฒะพัะฝัะน ะฝะพะผะตั
inet_pton(AF_INET, "203.0.113.42", &server_addr.sin_addr);

// ะจะะ 3: ะะพะทะฒะพะฝะธัั (ัััะฐะฝะพะฒะธัั ัะพะตะดะธะฝะตะฝะธะต)
printf("ะะฒะพะฝั ะฝะฐ 203.0.113.42:31337...\n");
if (connect(sockfd, (struct sockaddr*)&server_addr, sizeof(server_addr)) < 0) {
    perror("ะะต ะผะพะณั ะดะพะทะฒะพะฝะธัััั (connect failed)");
    // ะะพะถะตั ะฑััั: ECONNREFUSED, ETIMEDOUT, ENETUNREACH...
    close(sockfd);
    return 1;
}
printf("โ ะกะพะตะดะธะฝะตะฝะธะต ัััะฐะฝะพะฒะปะตะฝะพ! (connected)\n");

// ะจะะ 4: ะะพะฒะพัะธัั ะฒ ัััะฑะบั (ะพัะฟัะฐะฒะธัั ะดะฐะฝะฝัะต)
char message[] = "AUTH MOONLIGHT2024\n";
printf("ะะพะฒะพัั: %s", message);
ssize_t sent = send(sockfd, message, strlen(message), 0);
if (sent < 0) {
    perror("ะะต ะผะพะณั ะณะพะฒะพัะธัั (send failed)");
    close(sockfd);
    return 1;
}

// ะจะะ 5: ะกะปััะฐัั ะพัะฒะตั (ะฟะพะปััะธัั ะดะฐะฝะฝัะต)
char buffer[1024];
memset(buffer, 0, sizeof(buffer));
ssize_t received = recv(sockfd, buffer, sizeof(buffer) - 1, 0);
if (received < 0) {
    perror("ะะต ะผะพะณั ัะปััะฐัั (recv failed)");
    close(sockfd);
    return 1;
} else if (received == 0) {
    printf("โ ะกะตัะฒะตั ะฟะพะปะพะถะธะป ัััะฑะบั (connection closed)\n");
} else {
    printf("ะกะปััั: %s\n", buffer);
}

// ะจะะ 6: ะะพะปะพะถะธัั ัััะฑะบั (ะทะฐะบัััั ัะพะตะดะธะฝะตะฝะธะต)
printf("ะะปะฐะดั ัััะฑะบั...\n");
close(sockfd);
printf("โ ะะฐะทะณะพะฒะพั ะทะฐะฒะตัััะฝ\n");
```

**ะะปััะตะฒัะต ะพัะปะธัะธั TCP vs UDP:**

```
TCP (SOCK_STREAM) = ะขะตะปะตัะพะฝะฝัะน ะทะฒะพะฝะพะบ
โโ ะัะถะฝะพ ัััะฐะฝะพะฒะธัั ัะพะตะดะธะฝะตะฝะธะต (connect)
โโ ะะฐัะฐะฝัะธั ะดะพััะฐะฒะบะธ (ะตัะปะธ ัะบะฐะทะฐะปะธ โ ััะปััะฐั)
โโ ะะพััะดะพะบ ัะพััะฐะฝัะตััั (ัะปะพะฒะฐ ะฒ ะฟัะฐะฒะธะปัะฝะพะผ ะฟะพััะดะบะต)
โโ ะะตะดะปะตะฝะฝะตะต (handshake, ะฟะพะดัะฒะตัะถะดะตะฝะธั)

UDP (SOCK_DGRAM) = ะัะฟัะฐะฒะธัั ะพัะบัััะบั ะฟะพ ะฟะพััะต
โโ ะะตะท ัััะฐะฝะพะฒะบะธ ัะพะตะดะธะฝะตะฝะธั (ะฟัะพััะพ ะพัะฟัะฐะฒะธะป)
โโ ะะตั ะณะฐัะฐะฝัะธะธ ะดะพััะฐะฒะบะธ (ะผะพะถะตั ะฟะพัะตัััััั)
โโ ะะพััะดะพะบ ะฝะต ะณะฐัะฐะฝัะธัะพะฒะฐะฝ (ะผะพะณัั ะฟัะธะนัะธ ะฒัะฐะทะฝะพะฑะพะน)
โโ ะััััะตะต (ะฝะตั overhead)
```

---

### 7. ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ

```c
// ะัะตะณะดะฐ ะฟัะพะฒะตััะนัะต ะฒะพะทะฒัะฐัะฐะตะผัะต ะทะฝะฐัะตะฝะธั!

if (socket(...) < 0) {
    perror("socket");  // ะัะฒะพะดะธั ัะธััะตะผะฝัั ะพัะธะฑะบั
    exit(1);
}

if (connect(...) < 0) {
    switch (errno) {
        case ECONNREFUSED:
            printf("Connection refused (server not running?)\n");
            break;
        case ETIMEDOUT:
            printf("Connection timeout\n");
            break;
        case ENETUNREACH:
            printf("Network unreachable\n");
            break;
        default:
            perror("connect");
    }
    exit(1);
}
```

---

### 7. ะะตะฑะปะพะบะธััััะธะต ัะพะบะตัั (advanced)

```c
#include <fcntl.h>

// ะกะดะตะปะฐัั ัะพะบะตั ะฝะตะฑะปะพะบะธััััะธะผ
int flags = fcntl(sockfd, F_GETFL, 0);
fcntl(sockfd, F_SETFL, flags | O_NONBLOCK);

// ะขะตะฟะตัั recv() ะฝะต ะฑะปะพะบะธััะตั!
ssize_t n = recv(sockfd, buffer, sizeof(buffer), 0);
if (n < 0 && errno == EWOULDBLOCK) {
    printf("No data available yet\n");
}
```

**ะะฐัะตะผ?** ะะปั ะพะดะฝะพะฒัะตะผะตะฝะฝะพะน ัะฐะฑะพัั ั ะฝะตัะบะพะปัะบะธะผะธ ัะพะบะตัะฐะผะธ (`select()`, `poll()`, `epoll()`).

---

## ๐ฏ ะะธััะธั: "MOONLIGHT Client"

### ะะตะณะตะฝะดะฐ

ะั ะฝะฐัะปะธ ะฐะดัะตั **203.0.113.42:31337**. ะขะตะฟะตัั ะฝัะถะฝะพ ะฟะพะดะบะปััะธัััั ะธ ะฟัะพะนัะธ ะฐััะตะฝัะธัะธะบะฐัะธั.

V. ะธัะฟะพะปัะทัะตั **challenge-response** ะฟัะพัะพะบะพะป:

```
Client โ Server: AUTH MOONLIGHT2024
Server โ Client: CHALLENGE 0x12345678
Client โ Server: RESPONSE 0xXXXXXXXX  (XOR challenge ั ัะตัะตะผ ะบะปััะฐ)
Server โ Client: ACCESS_GRANTED\nSECRET_MESSAGE
```

**ะะฐัะฐ ะทะฐะดะฐัะฐ**: ะฝะฐะฟะธัะฐัั ะบะปะธะตะฝั, ะบะพัะพััะน:
1. ะะพะดะบะปััะฐะตััั ะบ ัะตัะฒะตัั
2. ะัะฟัะฐะฒะปัะตั `AUTH <key>`
3. ะะพะปััะฐะตั challenge
4. ะััะธัะปัะตั response (XOR)
5. ะะพะปััะฐะตั ัะตะบัะตัะฝะพะต ัะพะพะฑัะตะฝะธะต

---

### ะคะพัะผะฐั ะฟัะพัะพะบะพะปะฐ

**1. ะััะตะฝัะธัะธะบะฐัะธั:**
```
Client โ "AUTH MOONLIGHT2024\n"
Server โ "CHALLENGE 305419896\n"  (ัะธัะปะพ ะฒ decimal)
```

**2. Response:**
```
Client โ "RESPONSE <calculated>\n"
```

**ะััะธัะปะตะฝะธะต response**:
```c
// ะัะตะฒะดะพะบะพะด:
uint32_t challenge = parse_from_server();
uint32_t key_hash = simple_hash("MOONLIGHT2024");  // ะัะพััะพะน ัะตั
uint32_t response = challenge ^ key_hash;
```

**ะัะพััะพะน ัะตั**:
```c
uint32_t simple_hash(const char *str) {
    uint32_t hash = 0;
    for (int i = 0; str[i]; i++) {
        hash = (hash * 31) + str[i];
    }
    return hash;
}
```

**3. ะะตะทัะปััะฐั:**
```
Server โ "ACCESS_GRANTED\n<secret_message>\n"
```

---

## ๐ ะกัััะบัััะฐ ัะฟะธะทะพะดะฐ

```
episode-10-socket-programming/
โโโ README.md              โ ะั ะทะดะตัั
โโโ mission.md
โโโ starter.c              โ ะจะฐะฑะปะพะฝ TCP ะบะปะธะตะฝัะฐ
โโโ artifacts/
โ   โโโ moonlight_client.c โ ะกะพะทะดะฐะนัะต ััะพั ัะฐะนะป
โโโ solution/
โ   โโโ simple_echo_client_solution.c  โ ะัะพะผะตะถััะพัะฝะฐั ะทะฐะดะฐัะฐ
โ   โโโ moonlight_client_solution.c
โ   โโโ test_server.c      โ ะะพะบะฐะปัะฝัะน ัะตััะพะฒัะน ัะตัะฒะตั
โโโ tests/
    โโโ test_simple_echo_client.sh  โ ะขะตััั ะดะปั ะฟัะพะผะตะถััะพัะฝะพะน ะทะฐะดะฐัะธ
    โโโ test.sh
```

### ๐ก ะะฐะบ ัะฐะฑะพัะฐัั:

**๐ธ STEP 1: ะัะพะผะตะถััะพัะฝะฐั ะทะฐะดะฐัะฐ `simple_echo_client.c`**

ะัะตะถะดะต ัะตะผ ัะพะทะดะฐะฒะฐัั ัะปะพะถะฝัะน ะบะปะธะตะฝั ั ะฐััะตะฝัะธัะธะบะฐัะธะตะน, ะพัะฒะพะนัะต ะฑะฐะทะพะฒัะต ัะพะบะตัั!

1. **ะกะพะทะดะฐะนัะต** ัะฐะนะป `simple_echo_client.c` ะฒ `artifacts/`
2. **ะะตะฐะปะธะทัะนัะต** ะฟัะพััะพะน TCP-ะบะปะธะตะฝั:
   - `socket()` โ ัะพะทะดะฐะฝะธะต ัะพะบะตัะฐ
   - `connect()` โ ะฟะพะดะบะปััะตะฝะธะต ะบ ัะตัะฒะตัั
   - `send()` โ ะพัะฟัะฐะฒะบะฐ ัััะพะบะธ "HELLO MOONLIGHT"
   - `recv()` โ ะฟะพะปััะตะฝะธะต ััะฐ ะพะฑัะฐัะฝะพ
   - `close()` โ ะทะฐะบัััะธะต ัะพะตะดะธะฝะตะฝะธั
3. **ะะพะผะฟะธะปััะธั**:
   ```bash
   gcc -Wall -o simple_echo_client simple_echo_client.c
   ```
4. **ะขะตััะธัะพะฒะฐะฝะธะต**:
   ```bash
   # ะะฐะฟัััะธัะต echo-ัะตัะฒะตั ะฒ ะพัะดะตะปัะฝะพะผ ัะตัะผะธะฝะฐะปะต:
   nc -l 7777
   
   # ะ ะดััะณะพะผ ัะตัะผะธะฝะฐะปะต ะทะฐะฟัััะธัะต ะบะปะธะตะฝั:
   ./simple_echo_client 127.0.0.1 7777
   ```
5. **ะะฒัะพัะตััั**:
   ```bash
   cd tests/
   ./test_simple_echo_client.sh
   ```

**ะัะธะผะตั ะฒัะฒะพะดะฐ**:
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    SIMPLE ECHO CLIENT
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Target: 127.0.0.1:7777
Message: HELLO MOONLIGHT

[1/5] Creating socket...
  โ Socket created (fd=3)

[2/5] Setting up server address...
  โ Address: 127.0.0.1:7777
  โ Network byte order: 0x1E61

[3/5] Connecting to server...
  โ Connected!
  โ TCP handshake complete (SYN โ SYN-ACK โ ACK)

[4/5] Sending message...
  โ Sent: "HELLO MOONLIGHT" (15 bytes)

[5/5] Receiving echo...
  โ Received: "HELLO MOONLIGHT" (15 bytes)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    RESULT
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ Echo successful!
   Sent:     "HELLO MOONLIGHT"
   Received: "HELLO MOONLIGHT"
   Match: โ

๐ Connection closed.
```

---

**๐ธ STEP 2: ะัะฝะพะฒะฝะฐั ะทะฐะดะฐัะฐ `moonlight_client.c`**

ะะพัะปะต ะพัะฒะพะตะฝะธั ะฑะฐะทะพะฒัั ัะพะบะตัะพะฒ ะฟะตัะตัะพะดะธัะต ะบ ะพัะฝะพะฒะฝะพะน ะผะธััะธะธ!

1. **ะะทััะธัะต** `starter.c` โ ัะฐะผ ะฑะฐะทะพะฒัะน TCP ะบะปะธะตะฝั ั TODO
2. **ะกะพะทะดะฐะนัะต** ัะฐะนะป `artifacts/moonlight_client.c`
3. **ะะตะฐะปะธะทัะนัะต** challenge-response:
   - ะะพะดะบะปััะตะฝะธะต ัะตัะตะท `socket()` + `connect()`
   - ะัะฟัะฐะฒะบะฐ AUTH ั `send()`
   - ะะฐััะธะฝะณ challenge ะธะท `recv()`
   - ะััะธัะปะตะฝะธะต response (XOR)
   - ะะพะปััะตะฝะธะต ัะตะบัะตัะฝะพะณะพ ัะพะพะฑัะตะฝะธั
4. **ะกะบะพะผะฟะธะปะธััะนัะต**: `gcc -Wall -o moonlight_client artifacts/moonlight_client.c`
5. **ะะฐะฟัััะธัะต**: `./moonlight_client 203.0.113.42 31337`

> ๐ก **ะะปั ัะตััะธัะพะฒะฐะฝะธั**: ะธัะฟะพะปัะทัะนัะต `solution/test_server.c` ะปะพะบะฐะปัะฝะพ!

---

### ะะพะดัะบะฐะทะบะธ

<details>
<summary>ะะฐะบ ะฟะฐััะธัั "CHALLENGE 12345"?</summary>

```c
char buffer[1024];
recv(sockfd, buffer, sizeof(buffer), 0);

uint32_t challenge;
if (sscanf(buffer, "CHALLENGE %u", &challenge) == 1) {
    printf("Got challenge: 0x%08X\n", challenge);
}
```
</details>

<details>
<summary>ะะฐะบ ะฒััะธัะปะธัั response?</summary>

```c
uint32_t simple_hash(const char *str) {
    uint32_t hash = 0;
    for (int i = 0; str[i]; i++) {
        hash = (hash * 31) + str[i];
    }
    return hash;
}

uint32_t key_hash = simple_hash("MOONLIGHT2024");
uint32_t response = challenge ^ key_hash;
```
</details>

<details>
<summary>ะะฐะบ ะพัะฟัะฐะฒะธัั response?</summary>

```c
char response_msg[256];
snprintf(response_msg, sizeof(response_msg), "RESPONSE %u\n", response);
send(sockfd, response_msg, strlen(response_msg), 0);
```
</details>

---

## โ ะัะพะฒะตัะบะฐ

```bash
# ะะพะผะฟะธะปััะธั
gcc -Wall -o moonlight_client artifacts/moonlight_client.c

# ะขะตััะธัะพะฒะฐะฝะธะต (ะปะพะบะฐะปัะฝัะน ัะตัะฒะตั)
gcc -Wall -o test_server solution/test_server.c
./test_server &  # ะะฐะฟัััะธัั ะฒ ัะพะฝะต
./moonlight_client 127.0.0.1 31337

# ะััะฐะฝะพะฒะธัั ัะตัะฒะตั
pkill test_server
```

**ะัะธัะตัะธะธ ััะฟะตัะฐ**:
- ะะปะธะตะฝั ััะฟะตัะฝะพ ะฟะพะดะบะปััะฐะตััั
- ะัะฟัะฐะฒะปัะตั AUTH ะบะพััะตะบัะฝะพ
- ะะฐััะธั challenge
- ะััะธัะปัะตั ะฟัะฐะฒะธะปัะฝัะน response
- ะะพะปััะฐะตั ACCESS_GRANTED ะธ ัะตะบัะตัะฝะพะต ัะพะพะฑัะตะฝะธะต
- ะะพััะตะบัะฝะพ ะทะฐะบััะฒะฐะตั ัะพะตะดะธะฝะตะฝะธะต

---

## ๐ฌ DEBRIEFING

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะะะะะฆะะฏ: ะะฒะฐััะธัะฐ, ัะฐะนะพะฝ ะัะฑะฐั, ะะพัะบะฒะฐ                 โ
โ  ะะะะะฏ:   14:42, ััะตะดะฐ, 1 ะพะบััะฑัั                       โ
โ  ะกะขะะขะฃะก:  ๐ข CONNECTION ESTABLISHED                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

`moonlight_client` ะทะฐะฟััะตะฝ. ะกะพะตะดะธะฝะตะฝะธะต ัััะฐะฝะพะฒะปะตะฝะพ. ะะตะทัะปััะฐั:

```
=== MOONLIGHT CLIENT ===
Connecting to 203.0.113.42:31337... โ
Sending AUTH... โ
Received challenge: 0x12345678
Calculating response... โ
Sending response... โ

Server response:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ACCESS_GRANTED                         โ
โ                                         โ
โ  ะขั ะฟะพะดะบะปััะธะปัั ะบ ะฟะตัะฒะพะผั ัะทะปั.         โ
โ  ะะพ ััะพ ัะพะปัะบะพ ะฝะฐัะฐะปะพ ัะตัะธ.             โ
โ                                         โ
โ  ะกะปะตะดัััะธะน ัะฐะณ:                         โ
โ  ะะะะะฅะะะข ะขะะะคะะะ                       โ
โ                                         โ
โ  Episode 11: Packet Analysis            โ
โ  ะะฐััะธัั ัะธัะฐัั ััะถะธะต ะฟะฐะบะตัั.           โ
โ                                         โ
โ  โ V.                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Connection closed gracefully.
```

**ะงัะพ ะฒั ัะทะฝะฐะปะธ:**
- **TCP handshake** ะฟัะพัะตะป ััะฟะตัะฝะพ (SYN โ SYN-ACK โ ACK)
- **Challenge-response** โ ะฟัะพััะฐั, ะฝะพ ัััะตะบัะธะฒะฝะฐั ะฐััะตะฝัะธัะธะบะฐัะธั
- **XOR ั ัะตัะตะผ** โ ะฑะฐะทะพะฒัะน ะผะตัะพะด ะทะฐัะธัั
- ะกะตัะฒะตั ะพัะฟัะฐะฒะธะป **ะบะพะพัะดะธะฝะฐัั ัะปะตะดัััะตะณะพ ัะทะปะฐ**

ะ 14:40 ะฝะพะฒะพะต ัะพะพะฑัะตะฝะธะต:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  FROM: V.                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                         โ
โ  ะกะพะตะดะธะฝะตะฝะธะต โ ััะพ ัะพะปัะบะพ ะฝะฐัะฐะปะพ.        โ
โ  ะะฐััะพััะฐั ัะธะปะฐ โ ะฒ ะะะะะฅะะะขะ.          โ
โ                                         โ
โ  Episode 11: Packet Analysis            โ
โ  ะะดั ะฝะฐ ัะปะตะดัััะตะผ ััะพะฒะฝะต.               โ
โ                                         โ
โ  โ V.                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะะพะดะบะปััะธัััั ะผะพะถะตั ะบะฐะถะดัะน. ะะพะฝะธะผะฐัั ััะฐัะธะบ โ ะตะดะธะฝะธัั.**

### ๐๏ธ ะะฐะฒัะบ ัะฐะทะฑะปะพะบะธัะพะฒะฐะฝ:
**"Socket Master"** โ ะั ะฒะปะฐะดะตะตัะต TCP/IP ะฝะฐ ััะพะฒะฝะต ะบะพะดะฐ. ะกะพะบะตัั ะฑะพะปััะต ะฝะต ัะฐะนะฝะฐ.

---

## ๐ ะะะะขะะะะฌะะซะ ะะะะะะกะซ

ะัะพะฒะตัััะต ัะฒะพั ะฟะพะฝะธะผะฐะฝะธะต Episode 10 (ะฒะพะฟัะพัั ะธะฝัะตะณัะธัะพะฒะฐะฝั ะฒ ััะถะตั ะผะธััะธะธ):

### ๐ข ะะฐะทะพะฒะพะต ะฟะพะฝะธะผะฐะฝะธะต (4 ะฒะพะฟัะพัะฐ)

**1. ะะพัะตะผั ะฟัะธ ะฟะตัะฒะพะน ะฟะพะฟััะบะต ะฟะพะดะบะปััะตะฝะธั (10:16) ะฒั ะฟะพะปััะธะปะธ CONNECTION REFUSED?**

<details>
<summary>ะัะฒะตั</summary>

**ะกะตัะฒะตั V. ะฑัะป ะฟะพะด DDoS-ะฐัะฐะบะพะน ะพั ะฐะณะตะฝัะพะฒ Z.!**

ะขะตัะฝะธัะตัะบะธ:
- ะะณะตะฝัั Z. ะพัะฟัะฐะฒะปัะปะธ ัััััะธ SYN-ะฟะฐะบะตัะพะฒ ั 185.220.101.0/24
- ะกะตัะฒะตั ะฝะต ะผะพะณ ะพะฑัะฐะฑะพัะฐัั ะปะตะณะธัะธะผะฝัะต ะทะฐะฟัะพัั
- `connect()` ะฒะตัะฝัะป ะพัะธะฑะบั `ECONNREFUSED`

ะ ะบะพะดะต:
```c
if (connect(sockfd, ...) < 0) {
    if (errno == ECONNREFUSED) {
        printf("Server ะฝะต ะพัะฒะตัะฐะตั - ะฒะพะทะผะพะถะฝะพ, ะฟะพะด ะฐัะฐะบะพะน!\n");
    }
}
```

**ะฃัะพะบ:** ะ ัะตะฐะปัะฝะพััะธ ัะตัะฒะตัั ะผะพะณัั ะฑััั ะฝะตะดะพัััะฟะฝั ะฟะพ ัะฐะทะฝัะผ ะฟัะธัะธะฝะฐะผ (ะฐัะฐะบะฐ, ะฟะตัะตะณััะทะบะฐ, firewall).
</details>

**2. ะงัะพ ัะฐะบะพะต TCP 3-way handshake ะธ ะบะฐะบ ะพะฝ ะฟะพะผะพะณ ัััะฐะฝะพะฒะธัั ัะพะตะดะธะฝะตะฝะธะต ั ัะตัะฒะตัะพะผ V.?**

<details>
<summary>ะัะฒะตั</summary>

**TCP 3-way handshake** โ ััะพ ะฟัะพัะตัั ัััะฐะฝะพะฒะบะธ ะฝะฐะดัะถะฝะพะณะพ ัะพะตะดะธะฝะตะฝะธั:

```
ะะซ โ ะกะะะะะ V.:     SYN (seq=1000)
                    "ะัะธะฒะตั! ะฅะพัั ะฟะพะดะบะปััะธัััั!"

ะกะะะะะ V. โ ะะซ:     SYN-ACK (seq=5000, ack=1001)
                    "ะะบะตะน! ะฏ ะณะพัะพะฒ!"

ะะซ โ ะกะะะะะ V.:     ACK (ack=5001)
                    "ะัะปะธัะฝะพ! ะะฐัะธะฝะฐะตะผ!"

โโโ ะกะะะะะะะะะ ะฃะกะขะะะะะะะะ โโโ
```

**ะ ะผะธััะธะธ:**
- 10:47 โ ะฒัะพัะฐั ะฟะพะฟััะบะฐ
- `connect()` ะฒัะฟะพะปะฝะธะป handshake ะฐะฒัะพะผะฐัะธัะตัะบะธ
- ะะพัะปะต ACK โ ะผะพะถะฝะพ ะพัะฟัะฐะฒะปััั `AUTH MOONLIGHT2024`

**ะะฐัะตะผ 3 ะฟะฐะบะตัะฐ?**
- ะะฐัะฐะฝัะธั: ะพะฑะฐ ะทะฝะฐัั, ััะพ ะบะฐะฝะฐะป ัะฐะฑะพัะฐะตั ะฒ ะพะฑะต ััะพัะพะฝั
- ะกะธะฝััะพะฝะธะทะฐัะธั sequence numbers
- ะะฐัะธัะฐ ะพั old duplicate packets
</details>

**3. ะะฐัะตะผ V. ะธัะฟะพะปัะทะพะฒะฐะป challenge-response ะฐััะตะฝัะธัะธะบะฐัะธั ะฒะผะตััะพ ะฟัะพััะพะน ะพัะฟัะฐะฒะบะธ ะฟะฐัะพะปั?**

<details>
<summary>ะัะฒะตั</summary>

**ะะตะทะพะฟะฐัะฝะพััั!**

**ะะปะพัะพะน ะฒะฐัะธะฐะฝั** (ะฟัะพััะฐั ะพัะฟัะฐะฒะบะฐ):
```
ะะซ โ ะกะะะะะ: "ะะฐัะพะปั: MOONLIGHT2024"
```
โ ะะณะตะฝัั Z. ะฟะตัะตัะฒะฐััะฒะฐัั ะฟะฐะบะตั โ ัะทะฝะฐัั ะฟะฐัะพะปั!

**ะฅะพัะพัะธะน ะฒะฐัะธะฐะฝั** (challenge-response):
```
ะะซ โ ะกะะะะะ:    "AUTH MOONLIGHT2024"
ะกะะะะะ โ ะะซ:    "CHALLENGE 0x7FA3B2C1"  (ัะปััะฐะนะฝะพะต ัะธัะปะพ!)
ะะซ โ ะกะะะะะ:    "RESPONSE 0x3089A9FD"   (challenge XOR hash(ะฟะฐัะพะปั))
```
โ ะะฐะถะดัะน ัะฐะท challenge **ะฝะพะฒัะน**!  
โ ะะตัะตัะฒะฐั ะฑะตัะฟะพะปะตะทะตะฝ โ ะฒ ัะปะตะดัััะธะน ัะฐะท challenge ะดััะณะพะน!

**ะ ะผะธััะธะธ:**
- Challenge ะผะตะฝัะตััั ะบะฐะถะดัะต 60 ัะตะบัะฝะด
- ะะฐัะธัะฐ ะพั replay-ะฐัะฐะบ
- ะะณะตะฝัั Z. ะฝะต ะผะพะณัั ะฟะพะฒัะพัะธัั ะฒะฐัั ัะตััะธั

**ะฃัะพะบ:** ะะธะบะพะณะดะฐ ะฝะต ะพัะฟัะฐะฒะปัะนัะต ะฟะฐัะพะปะธ ะฝะฐะฟััะผัั!
</details>

**4. ะะฐะบะฐั ะพัะธะฑะบะฐ ะฒะพะทะฝะธะบะปะฐ ะฑั, ะตัะปะธ ะฑั ะฒั ะทะฐะฑัะปะธ ะฒัะทะฒะฐัั `close(sockfd)` ะฟะพัะปะต ะทะฐะฒะตััะตะฝะธั?**

<details>
<summary>ะัะฒะตั</summary>

**ะฃัะตัะบะฐ ัะฐะนะปะพะฒะพะณะพ ะดะตัะบัะธะฟัะพัะฐ!**

**ะัะพะฑะปะตะผะฐ:**
```c
int sockfd = socket(...);
connect(sockfd, ...);
send(sockfd, ...);
recv(sockfd, ...);
// ะะฐะฑัะปะธ close(sockfd)!  โ ะฃะขะะงะะ!
```

**ะะพัะปะตะดััะฒะธั:**
1. **ะะตััััั ะฝะต ะพัะฒะพะฑะพะถะดะฐัััั:**
   - ะะตัะบัะธะฟัะพั ะทะฐะฝัั ะฝะฐะฒัะตะณะดะฐ
   - ะฃ ะฟัะพัะตััะฐ ะปะธะผะธั ะดะตัะบัะธะฟัะพัะพะฒ (ะพะฑััะฝะพ 1024)
   
2. **ะกะตัะฒะตั ะถะดัั FIN:**
   - ะกะพะตะดะธะฝะตะฝะธะต ะฒะธัะธั ะฒ ESTABLISHED
   - ะะฐะฝะธะผะฐะตั ะฟะฐะผััั ะฝะฐ ัะตัะฒะตัะต V.
   
3. **ะัะธ ะฟะพะฒัะพัะฝัั ะทะฐะฟััะบะฐั:**
   - ะััััะพ ะธััะตัะฟะฐะตัะต ะปะธะผะธั
   - ะะพะฒัะต `socket()` ะฒะตัะฝัั -1 (EMFILE)

**ะ ะผะธััะธะธ:**
- ะัะปะธ ะฑั ะฒั ะทะฐะฑัะปะธ `close()` ะฟะพัะปะต ะบะฐะถะดะพะน ะฟะพะฟััะบะธ ะฟะพะดะบะปััะตะฝะธั
- ะะพัะปะต ~1000 ะฟะพะฟััะพะบ โ "Too many open files"
- ะัะพะณัะฐะผะผะฐ ัะปะพะผะฐะตััั

**ะัะฐะฒะธะปัะฝะพ:**
```c
close(sockfd);  // ะะกะะะะ ะทะฐะบััะฒะฐะนัะต ัะพะบะตัั!
```

**ะะฝะฐะปะพะณะธั:** ะะฐะบ ะฟะพัะตััะฝะฝัะต ะบะปััะธ ะพั ะบะฒะฐััะธั (ะธะท Episode 07 ะฟัะพ ััะตัะบะธ ะฟะฐะผััะธ)!
</details>

---

### ๐ก ะัะฐะบัะธะบะฐ (5 ะฒะพะฟัะพัะพะฒ)

**5. ะ ะผะธััะธะธ ะฒั ะพัะฟัะฐะฒะปัะปะธ "AUTH MOONLIGHT2024\n". ะงัะพ ะฟัะพะธะทะพะนะดัั, ะตัะปะธ ะทะฐะฑััั `\n`?**

<details>
<summary>ะัะฒะตั</summary>

**ะกะตัะฒะตั ะผะพะถะตั ะฝะต ัะฐัะฟะพะทะฝะฐัั ะบะพะผะฐะฝะดั!**

**ะะฐะฒะธัะธั ะพั ะฟัะพัะพะบะพะปะฐ ัะตัะฒะตัะฐ:**

**ะะฐัะธะฐะฝั 1:** ะกะตัะฒะตั ะถะดัั `\n` ะบะฐะบ ะฟัะธะทะฝะฐะบ ะบะพะฝัะฐ ะบะพะผะฐะฝะดั:
```c
// ะกะตัะฒะตั:
char buffer[1024];
recv(sockfd, buffer, sizeof(buffer), 0);
// ะัะตั \n ััะพะฑั ะฟะพะฝััั, ััะพ ะบะพะผะฐะฝะดะฐ ะณะพัะพะฒะฐ
char *newline = strchr(buffer, '\n');
if (!newline) {
    // ะะพะผะฐะฝะดะฐ ะฝะต ะทะฐะฒะตััะตะฝะฐ, ะถะดัะผ ะตัั ะดะฐะฝะฝัั
    // Timeout โ ัะฐะทััะฒ ัะพะตะดะธะฝะตะฝะธั
}
```

**ะะฐัะธะฐะฝั 2:** ะกะตัะฒะตั ัะธัะฐะตั ัะธะบัะธัะพะฒะฐะฝะฝะพะต ะบะพะปะธัะตััะฒะพ ะฑะฐะนั:
```c
recv(sockfd, buffer, 19, 0);  // "AUTH MOONLIGHT2024" = 19 ะฑะฐะนั
// ะะฐะฑะพัะฐะตั ะะะ \n
```

**ะ ะผะธััะธะธ V.:**
- ะัะพัะพะบะพะป ัะตะบััะพะฒัะน, ะฟะพัััะพัะฝัะน
- `\n` = ัะฐะทะดะตะปะธัะตะปั ะบะพะผะฐะฝะด
- ะะตะท `\n` โ ัะตัะฒะตั ะถะดัั ะฟัะพะดะพะปะถะตะฝะธั โ timeout โ ECONNRESET

**ะฃัะพะบ:** ะัะตะณะดะฐ ัะธัะฐะนัะต ัะฟะตัะธัะธะบะฐัะธั ะฟัะพัะพะบะพะปะฐ!
</details>

**6. ะััะธัะปะธัะต response ะดะปั challenge 0x12345678, ะตัะปะธ ะบะปัั "MOONLIGHT2024":**

<details>
<summary>ะัะฒะตั</summary>

**ะจะฐะณ 1:** ะััะธัะปะธัั hash ะบะปััะฐ
```c
uint32_t simple_hash(const char *str) {
    uint32_t hash = 0;
    for (int i = 0; str[i]; i++) {
        hash = (hash * 31) + str[i];
    }
    return hash;
}

hash("MOONLIGHT2024") = 0x4F2A1B3C  // (ัะตะทัะปััะฐั ะฒััะธัะปะตะฝะธั)
```

**ะจะฐะณ 2:** XOR challenge ั hash
```c
uint32_t challenge = 0x12345678;
uint32_t key_hash  = 0x4F2A1B3C;
uint32_t response  = challenge ^ key_hash;

response = 0x12345678 ^ 0x4F2A1B3C
         = 0x5D1E4D44
```

**ะัะฒะตั:** `0x5D1E4D44`

**ะ ะฑะธัะฐั:**
```
Challenge: 00010010 00110100 01010110 01111000
Key hash:  01001111 00101010 00011011 00111100
           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
Response:  01011101 00011110 01001101 01000100
           = 0x5D1E4D44
```
</details>

**7. ะะพัะตะผั `send()` ะผะพะถะตั ะฒะตัะฝััั ะผะตะฝััะต ะฑะฐะนั, ัะตะผ ะฒั ะทะฐะฟัะพัะธะปะธ?**

<details>
<summary>ะัะฒะตั</summary>

**TCP ัะฐะฑะพัะฐะตั ั ะฑััะตัะฐะผะธ, ะฐ ัะตัั ะผะพะถะตั ะฑััั ะผะตะดะปะตะฝะฝะพะน!**

**ะัะธะผะตั:**
```c
char message[1000] = "AUTH MOONLIGHT2024...";  // 1000 ะฑะฐะนั
ssize_t sent = send(sockfd, message, 1000, 0);
printf("ะัะฟัะฐะฒะปะตะฝะพ: %ld ะฑะฐะนั\n", sent);  // ะะพะถะตั ะฑััั < 1000!
```

**ะัะธัะธะฝั:**
1. **ะััะตั ะพัะฟัะฐะฒะบะธ ะฟะพะปะพะฝ:**
   - ะฃ ัะพะบะตัะฐ ะตััั send buffer (ะพะฑััะฝะพ 16-64 KB)
   - ะัะปะธ ะฑััะตั ะฟะพััะธ ะฟะพะปะพะฝ โ `send()` ะทะฐะฟะธัะตั ัะบะพะปัะบะพ ะฟะพะผะตััะธััั
   
2. **ะะตะดะปะตะฝะฝะฐั ัะตัั:**
   - ะะฐะฝะฝัะต ะฝะต ััะฟะตะปะธ ัะนัะธ ะฒ ัะตัั
   - ะััะตั ะฟะตัะตะฟะพะปะฝะตะฝ โ ัะฐััะธัะฝะฐั ะพัะฟัะฐะฒะบะฐ
   
3. **ะะตะฑะปะพะบะธััััะธะน ัะตะถะธะผ:**
   - `send()` ะฝะต ะถะดัั โ ะฒะพะทะฒัะฐัะฐะตั ััะพ ััะฟะตะป

**ะ ะผะธััะธะธ:**
- "AUTH MOONLIGHT2024\n" = 20 ะฑะฐะนั (ะผะฐะปะพ)
- ะกะบะพัะตะต ะฒัะตะณะพ, `send()` ะฒะตัะฝัั 20 (ะฒัั ะพัะฟัะฐะฒะปะตะฝะพ)
- ะะพ **ะฒัะตะณะดะฐ ะฟัะพะฒะตััะนัะต!**

**ะัะฐะฒะธะปัะฝัะน ะบะพะด:**
```c
ssize_t total_sent = 0;
while (total_sent < message_len) {
    ssize_t sent = send(sockfd, message + total_sent, 
                        message_len - total_sent, 0);
    if (sent < 0) {
        perror("send failed");
        break;
    }
    total_sent += sent;
}
```
</details>

**8. ะงัะพ ะพะทะฝะฐัะฐะตั, ะตัะปะธ `recv()` ะฒะตัะฝัะป 0?**

<details>
<summary>ะัะฒะตั</summary>

**ะกะตัะฒะตั ะทะฐะบััะป ัะพะตะดะธะฝะตะฝะธะต (FIN)!**

```c
ssize_t received = recv(sockfd, buffer, sizeof(buffer), 0);
if (received == 0) {
    printf("ะกะตัะฒะตั V. ะทะฐะฒะตััะธะป ัะพะตะดะธะฝะตะฝะธะต\n");
    // ะญัะพ ะฝะพัะผะฐะปัะฝะพ, ะตัะปะธ ะฒัั ะฟะพะปััะตะฝะพ
    close(sockfd);
}
```

**ะงัะพ ะฟัะพะธะทะพัะปะพ:**
- ะกะตัะฒะตั ะฒัะทะฒะฐะป `close(sockfd)`
- ะัะฟัะฐะฒะปะตะฝ TCP FIN ะฟะฐะบะตั
- ะะฐั `recv()` ะฒะตัะฝัะป 0 = "ะบะพะฝะตั ะฟะพัะพะบะฐ"

**ะ ะผะธััะธะธ:**
```
10:51 โ ะั ะฟะพะปััะธะปะธ "ACCESS GRANTED\n..."
        ะัั ะธะฝัะพัะผะฐัะธั ะฟะตัะตะดะฐะฝะฐ
        
        ะกะตัะฒะตั: close(client_fd);  โ ะัะฟัะฐะฒะบะฐ FIN
        
        ะะฐั recv() ะฒะตัะฝัะป 0
        โ ะกะพะตะดะธะฝะตะฝะธะต ะทะฐะฒะตััะตะฝะพ ะบะพััะตะบัะฝะพ
```

**ะัะปะธัะธะต ะพั ะพัะธะฑะบะธ:**
```c
if (received < 0) {
    // ะัะธะฑะบะฐ! (ECONNRESET, ETIMEDOUT...)
    perror("recv failed");
} else if (received == 0) {
    // ะะพัะผะฐะปัะฝะพะต ะทะฐะฒะตััะตะฝะธะต (FIN)
    printf("Connection closed gracefully\n");
}
```
</details>

**9. ะ ััะถะตัะต ัะตัะฒะตั ัะฐะผะพัะฝะธััะพะถะฐะตััั ัะตัะตะท 5 ัะฐัะพะฒ. ะะฐะบ ััะพ ัะตะฐะปะธะทะพะฒะฐัั ะฒ ะบะพะดะต?**

<details>
<summary>ะัะฒะตั</summary>

**ะะฐัะธะฐะฝั 1: ะขะฐะนะผะตั ะฝะฐ ัะตัะฒะตัะต**
```c
#include <time.h>

time_t start_time = time(NULL);
time_t deadline = start_time + (5 * 3600);  // 5 ัะฐัะพะฒ

while (1) {
    // ะัะธะฝะธะผะฐะตะผ ะบะปะธะตะฝัะพะฒ
    int client_fd = accept(server_fd, ...);
    
    // ะัะพะฒะตัะบะฐ deadline
    if (time(NULL) >= deadline) {
        printf("DEADLINE REACHED! Self-destructing...\n");
        unlink("server_data.db");  // ะฃะดะฐะปะธัั ะดะฐะฝะฝัะต
        close(server_fd);
        exit(0);  // ะะฐะฒะตััะธัั ัะตัะฒะตั
    }
    
    // ะะฑัะฐะฑะพัะฐัั ะบะปะธะตะฝัะฐ...
}
```

**ะะฐัะธะฐะฝั 2: ะัะดะตะปัะฝัะน ะฟะพัะพะบ-ัะฐะนะผะตั**
```c
#include <pthread.h>

void* timer_thread(void* arg) {
    sleep(5 * 3600);  // 5 ัะฐัะพะฒ
    printf("Self-destruct activated!\n");
    exit(0);  // ะฃะฑะธัั ะฒะตัั ะฟัะพัะตัั
}

int main() {
    pthread_t timer;
    pthread_create(&timer, NULL, timer_thread, NULL);
    
    // ะัะฝะพะฒะฝะพะน ัะธะบะป ัะตัะฒะตัะฐ...
}
```

**ะะฐัะธะฐะฝั 3: ะะฝะตัะฝะธะน cron/systemd timer**
```bash
# ะะฐะฟะปะฐะฝะธัะพะฒะฐัั ัะฝะธััะพะถะตะฝะธะต ัะตัะตะท 5 ัะฐัะพะฒ
at now + 5 hours <<< "pkill moonlight_server && rm -f /var/data/*"
```

**ะ ะผะธััะธะธ V.:**
- ะกะตัะฒะตั ะทะฐะฟััะตะฝ ะฒ 09:30
- Deadline: 14:30 (5 ัะฐัะพะฒ)
- ะั ััะฟะตะปะธ ะฟะพะดะบะปััะธัััั ะฒ 10:51 โ
</details>

---

### ๐ด ะะฝะฐะปะธะท ะบะพะดะฐ (3 ะฒะพะฟัะพัะฐ)

**10. ะะฐะนะดะธัะต ะพัะธะฑะบั ะฒ ััะพะผ ะบะพะดะต ะฟะพะดะบะปััะตะฝะธั ะบ ัะตัะฒะตัั V.:**

```c
int sockfd = socket(AF_INET, SOCK_STREAM, 0);
struct sockaddr_in addr;
addr.sin_family = AF_INET;
addr.sin_port = 31337;  // โ ะะจะะะะ?
inet_pton(AF_INET, "203.0.113.42", &addr.sin_addr);
connect(sockfd, (struct sockaddr*)&addr, sizeof(addr));
```

<details>
<summary>ะัะฒะตั</summary>

**ะัะธะฑะบะฐ: ะทะฐะฑัะปะธ `htons()` ะดะปั ะฟะพััะฐ!**

**ะัะพะฑะปะตะผะฐ:**
```c
addr.sin_port = 31337;  // โ Host byte order!
```

ะะฐ little-endian ะผะฐัะธะฝะต (Intel):
- `31337` = `0x7A69`
- ะ ะฟะฐะผััะธ: `69 7A` (ะผะปะฐะดัะธะน ะฑะฐะนั ะฟะตัะฒัะผ)
- ะกะตัะฒะตั ะถะดัั: `7A 69` (network byte order)
- **ะะพัั ะฝะตะฟัะฐะฒะธะปัะฝัะน!**

**ะัะฟัะฐะฒะปะตะฝะธะต:**
```c
addr.sin_port = htons(31337);  // โ Network byte order!
```

**ะะตะทัะปััะฐั ะพัะธะฑะบะธ:**
- ะะพะฟััะบะฐ ะฟะพะดะบะปััะธัััั ะบ ะฟะพััั 26985 (0x697A ะฒ decimal)
- `connect()` ะฒะตัะฝัั ECONNREFUSED
- "ะกะตัะฒะตั ะฝะตะดะพัััะฟะตะฝ" (ัะพัั ะพะฝ ัะฐะฑะพัะฐะตั ะฝะฐ ะฟะพััั 31337!)

**ะฃัะพะบ:** **ะะกะะะะ** ะธัะฟะพะปัะทัะนัะต `htons()` ะดะปั ะฟะพััะพะฒ!
</details>

**11. ะะพัะตะผั ััะพั ะบะพะด ะผะพะถะตั ะทะฐะฒะธัะฝััั ะฝะฐะฒัะตะณะดะฐ?**

```c
char buffer[1024];
while (1) {
    ssize_t n = recv(sockfd, buffer, sizeof(buffer), 0);
    if (n > 0) {
        printf("Received: %s\n", buffer);
        break;
    }
}
```

<details>
<summary>ะัะฒะตั</summary>

**`recv()` ะฑะปะพะบะธััะตั ะฝะฐะฒัะตะณะดะฐ, ะตัะปะธ ัะตัะฒะตั ะผะพะปัะธั!**

**ะัะพะฑะปะตะผะฐ:**
- `recv()` **ะฑะปะพะบะธััััะธะน** ะฒัะทะพะฒ ะฟะพ ัะผะพะปัะฐะฝะธั
- ะะดัั ะดะฐะฝะฝัั **ะฑะตัะบะพะฝะตัะฝะพ**
- ะัะปะธ ัะตัะฒะตั ะทะฐะฒะธั ะธะปะธ ะผะตะดะปะตะฝะฝัะน โ ะฒั ัะพะถะต ะทะฐะฒะธัะปะธ

**ะ ะผะธััะธะธ:**
- ะัะปะธ ัะตัะฒะตั V. ะฟะพะด DDoS-ะฐัะฐะบะพะน
- ะะปะธ ะฟะพัะตััะป ัะพะตะดะธะฝะตะฝะธะต
- ะะฐั ะบะปะธะตะฝั ะฟะพะฒะธัะฝะตั ะฒ `recv()`

**ะะตัะตะฝะธั:**

**1. Timeout:**
```c
struct timeval tv;
tv.tv_sec = 30;   // 30 ัะตะบัะฝะด timeout
tv.tv_usec = 0;
setsockopt(sockfd, SOL_SOCKET, SO_RCVTIMEO, &tv, sizeof(tv));

ssize_t n = recv(sockfd, buffer, sizeof(buffer), 0);
if (n < 0 && errno == EWOULDBLOCK) {
    printf("Timeout! ะกะตัะฒะตั ะฝะต ะพัะฒะตัะธะป ะทะฐ 30 ัะตะบัะฝะด\n");
}
```

**2. ะะตะฑะปะพะบะธััััะธะน ัะตะถะธะผ:**
```c
fcntl(sockfd, F_SETFL, O_NONBLOCK);
ssize_t n = recv(sockfd, buffer, sizeof(buffer), 0);
if (n < 0 && errno == EAGAIN) {
    printf("ะะฐะฝะฝัั ะฟะพะบะฐ ะฝะตั\n");
}
```

**3. select() ั ัะฐะนะผะฐััะพะผ:**
```c
fd_set readfds;
FD_ZERO(&readfds);
FD_SET(sockfd, &readfds);
struct timeval tv = {.tv_sec = 30};

if (select(sockfd + 1, &readfds, NULL, NULL, &tv) > 0) {
    recv(sockfd, buffer, sizeof(buffer), 0);  // ะะฐะฝะฝัะต ะตััั!
} else {
    printf("Timeout!\n");
}
```
</details>

**12. ะ ััะผ ะฟัะพะฑะปะตะผะฐ ััะพะน ะพะฑัะฐะฑะพัะบะธ challenge-response?**

```c
char buffer[1024];
recv(sockfd, buffer, sizeof(buffer), 0);
uint32_t challenge;
sscanf(buffer, "CHALLENGE %u", &challenge);

uint32_t response = challenge ^ 0x4F2A1B3C;  // โ ะะะะะะะะ?
char resp_msg[100];
sprintf(resp_msg, "RESPONSE %u\n", response);
send(sockfd, resp_msg, strlen(resp_msg), 0);
```

<details>
<summary>ะัะฒะตั</summary>

**ะัะธะฑะบะฐ: hardcoded hash ะบะปััะฐ!**

**ะัะพะฑะปะตะผั:**

1. **ะะฐะณะธัะตัะบะพะต ัะธัะปะพ:**
   ```c
   uint32_t response = challenge ^ 0x4F2A1B3C;  // ะงัะพ ััะพ?!
   ```
   - ะะตะฟะพะฝััะฝะพ, ะพัะบัะดะฐ ะฒะทัะปะพัั `0x4F2A1B3C`
   - ะัะปะธ ะบะปัั ะธะทะผะตะฝะธััั ("MOONLIGHT2025") โ ัะปะพะผะฐะตััั
   - ะะตะฒะพะทะผะพะถะฝะพ ะฟะตัะตะธัะฟะพะปัะทะพะฒะฐัั ะดะปั ะดััะณะพะณะพ ะบะปััะฐ

2. **ะะตั ะฟัะพะฒะตัะบะธ `recv()`:**
   ```c
   recv(sockfd, buffer, sizeof(buffer), 0);  // ะ ะตัะปะธ ะพัะธะฑะบะฐ?
   ```

3. **Buffer ะฝะต ะพะฑะฝัะปัะฝ:**
   ```c
   char buffer[1024];  // ะะพะถะตั ัะพะดะตัะถะฐัั ะผััะพั!
   ```

**ะัะฐะฒะธะปัะฝัะน ะบะพะด:**
```c
// 1. ะคัะฝะบัะธั ะฒััะธัะปะตะฝะธั hash
uint32_t simple_hash(const char *key) {
    uint32_t hash = 0;
    for (int i = 0; key[i]; i++) {
        hash = (hash * 31) + key[i];
    }
    return hash;
}

// 2. ะัะธัะผ challenge ั ะฟัะพะฒะตัะบะพะน
char buffer[1024];
memset(buffer, 0, sizeof(buffer));

ssize_t n = recv(sockfd, buffer, sizeof(buffer) - 1, 0);
if (n <= 0) {
    perror("recv failed");
    return -1;
}

// 3. ะะฐััะธะฝะณ
uint32_t challenge;
if (sscanf(buffer, "CHALLENGE %u", &challenge) != 1) {
    fprintf(stderr, "Invalid challenge format\n");
    return -1;
}

// 4. ะััะธัะปะตะฝะธะต response (ะฝะต hardcode!)
const char *key = "MOONLIGHT2024";
uint32_t key_hash = simple_hash(key);
uint32_t response = challenge ^ key_hash;

// 5. ะัะฟัะฐะฒะบะฐ
char resp_msg[100];
snprintf(resp_msg, sizeof(resp_msg), "RESPONSE %u\n", response);
send(sockfd, resp_msg, strlen(resp_msg), 0);
```

**ะฃัะพะบ:** ะะธะบะพะณะดะฐ ะฝะต hardcode ะบัะธะฟัะพะณัะฐัะธัะตัะบะธะต ะทะฝะฐัะตะฝะธั!
</details>

---

### ๐ฏ ะกัะถะตั (2 ะฒะพะฟัะพัะฐ)

**13. ะ 10:16 ะฟะตัะฒะฐั ะฟะพะฟััะบะฐ ะฟะพะดะบะปััะตะฝะธั ะฟัะพะฒะฐะปะธะปะฐัั (DDoS-ะฐัะฐะบะฐ). ะะฐะบ ะผะพะถะฝะพ ะฑัะปะพ ะพะฑะฝะฐััะถะธัั ะฐัะฐะบั ะดะพ ะฟะพะฟััะบะธ ะฟะพะดะบะปััะตะฝะธั?**

<details>
<summary>ะัะฒะตั</summary>

**ะกะบะฐะฝะธัะพะฒะฐะฝะธะต ัะตัะธ ะฟะตัะตะด ะฟะพะดะบะปััะตะฝะธะตะผ!**

**ะกะฟะพัะพะฑั ะพะฑะฝะฐััะถะตะฝะธั:**

**1. Ping ัะตัะฒะตัะฐ:**
```bash
$ ping 203.0.113.42
PING 203.0.113.42: 56 data bytes
Request timeout for icmp_seq 0  โ ะกะตัะฒะตั ะฝะต ะพัะฒะตัะฐะตั!
Request timeout for icmp_seq 1
```

**2. ะัะพะฒะตัะบะฐ ะฟะพััะฐ (nc/telnet):**
```bash
$ nc -zv 203.0.113.42 31337
nc: connect to 203.0.113.42 port 31337 (tcp) failed: Connection refused
```

**3. ะะฝะฐะปะธะท ััะฐัะธะบะฐ (tcpdump/wireshark):**
```bash
$ sudo tcpdump -i any host 203.0.113.42
18:16:01 IP 185.220.101.5 > 203.0.113.42: Flags [S], seq 1234
18:16:01 IP 185.220.101.7 > 203.0.113.42: Flags [S], seq 5678
18:16:01 IP 185.220.101.9 > 203.0.113.42: Flags [S], seq 9101
...
# ะขััััะธ SYN ะฟะฐะบะตัะพะฒ! โ DDoS-ะฐัะฐะบะฐ!
```

**4. ะัะพะฒะตัะบะฐ ะดะพัััะฟะฝะพััะธ (ะฒ ะบะพะดะต):**
```c
int sockfd = socket(AF_INET, SOCK_STREAM, 0);

// ะฃััะฐะฝะพะฒะธัั timeout ะฝะฐ connect
struct timeval tv = {.tv_sec = 5};  // 5 ัะตะบัะฝะด
setsockopt(sockfd, SOL_SOCKET, SO_RCVTIMEO, &tv, sizeof(tv));

if (connect(sockfd, ...) < 0) {
    if (errno == ETIMEDOUT) {
        printf("ะกะตัะฒะตั ะฝะต ะพัะฒะตัะฐะตั - ะฒะพะทะผะพะถะฝะพ, ะฟะพะด ะฐัะฐะบะพะน\n");
        printf("ะะพะฟัะพะฑัะตะผ ะฟะพะทะถะต...\n");
        sleep(1800);  // ะะพะดะพะถะดะฐัั 30 ะผะธะฝัั
    }
}
```

**ะ ะผะธััะธะธ:**
- V. ะฟัะตะดัะฟัะตะดะธะป ะฒ SMS (10:17): "ะัะฐะบั ะพััะฐะถะฐั"
- ะั ะฟะพะดะพะถะดะฐะปะธ 30 ะผะธะฝัั
- 10:47 โ ััะฟะตัะฝะพะต ะฟะพะดะบะปััะตะฝะธะต โ
</details>

**14. ะะพัะตะผั ะบะพะพัะดะธะฝะฐัั ัะปะตะดัััะตะณะพ ัะทะปะฐ (10.0.0.1:4433) โ ััะพ private IP? ะะฐะบ ะบ ะฝะตะผั ะฟะพะดะบะปััะธัััั?**

<details>
<summary>ะัะฒะตั</summary>

**10.0.0.1 โ private IP (RFC 1918)!**

**ะัะพะฑะปะตะผะฐ:**
- `10.0.0.0/8` โ ะฝะต ะผะฐัััััะธะทะธััะตััั ะฒ ะธะฝัะตัะฝะตัะต
- ะญัะพ **ะฒะฝัััะตะฝะฝะธะน ะฐะดัะตั** ะปะพะบะฐะปัะฝะพะน ัะตัะธ
- ะััะผะพะต ะฟะพะดะบะปััะตะฝะธะต ะธะท ะธะฝัะตัะฝะตัะฐ ะฝะตะฒะพะทะผะพะถะฝะพ

**ะะฐัะธะฐะฝัั ะฟะพะดะบะปััะตะฝะธั:**

**1. ะั ัะถะต ะฒะฝัััะธ ัะตัะธ:**
```bash
# ะัะพะฒะตัะบะฐ ะธะฝัะตััะตะนัะพะฒ
$ ip addr
eth0: 10.0.0.5/8  โ ะั ะฒ ัะตัะธ 10.0.0.0/8!

# ะะพะถะฝะพ ะฟะพะดะบะปััะธัััั ะฝะฐะฟััะผัั
$ ./moonlight_client 10.0.0.1 4433
โ Connected!
```

**2. VPN / Tunnel:**
```bash
# V. ะฟัะตะดะพััะฐะฒะธะป VPN ะดะพัััะฟ
$ sudo openvpn moonlight.ovpn
# ะขะตะฟะตัั ั ะฒะฐั ะตััั tun0 ั IP 10.0.0.100
$ ./moonlight_client 10.0.0.1 4433
```

**3. SSH Port Forwarding:**
```bash
# ะงะตัะตะท ะฟัะพะผะตะถััะพัะฝัะน ัะตัะฒะตั
$ ssh -L 4433:10.0.0.1:4433 user@203.0.113.42
# ะะพะบะฐะปัะฝะพ:
$ ./moonlight_client 127.0.0.1 4433
# โ ะฟะตัะตะฝะฐะฟัะฐะฒะธััั ะฝะฐ 10.0.0.1:4433
```

**4. ะญัะพ loopback ัะตัั:**
```bash
# ะะปั ัะตััะธัะพะฒะฐะฝะธั ะธัะฟะพะปัะทัะตััั 127.0.0.1
# ะ ัะตะฐะปัะฝะพััะธ 10.0.0.1 โ 127.0.0.1 (ะปะพะบะฐะปัะฝัะน ัะตัะฒะตั)
$ ./test_server 4433 &  # ะะฐะฟัััะธัั ะฝะฐ 127.0.0.1:4433
$ ./moonlight_client 127.0.0.1 4433
```

**ะ ััะถะตัะต:**
- Episode 11-12: ะฟะตัะตัะฒะฐั ััะฐัะธะบะฐ ะฝะฐ `10.0.0.1:4433`
- ะกะบะพัะตะต ะฒัะตะณะพ, ััะพ **ะปะพะบะฐะปัะฝัะน ัะตััะพะฒัะน ัะตัะฒะตั**
- ะะปั ะพะฑััะตะฝะธั ะธัะฟะพะปัะทัะตััั 127.0.0.1 (loopback)
- ะ ัะตะฐะปัะฝะพะน ะผะธััะธะธ ะฑัะป ะฑั public IP
</details>

---

### ๐ ะัะพะดะฒะธะฝัััะต (1 ะฒะพะฟัะพั)

**15. V. ัะฟะพะผัะฝัะป, ััะพ challenge ะผะตะฝัะตััั ะบะฐะถะดัะต 60 ัะตะบัะฝะด. ะะฐะบ ััะพ ะทะฐัะธัะฐะตั ะพั replay-ะฐัะฐะบะธ?**

<details>
<summary>ะัะฒะตั</summary>

**Replay-ะฐัะฐะบะฐ = ะฟะพะฒัะพั ะฟะตัะตัะฒะฐัะตะฝะฝะพะน ัะตััะธะธ!**

**ะกัะตะฝะฐัะธะน ะฐัะฐะบะธ ะะะ ะทะฐัะธัั:**

```
1. ะั โ ะกะตัะฒะตั V.: "AUTH MOONLIGHT2024"
   ะกะตัะฒะตั โ ะั:    "CHALLENGE 12345"
   ะั โ ะกะตัะฒะตั:    "RESPONSE 67890"
   ะกะตัะฒะตั:         "ACCESS GRANTED"
   
2. ะะณะตะฝั Z. ะฟะตัะตัะฒะฐััะฒะฐะตั ะฟะฐะบะตัั (Wireshark)
   
3. ะะพะทะถะต ะฐะณะตะฝั Z. ะฟะพะฒัะพััะตั:
   ะะณะตะฝั Z. โ ะกะตัะฒะตั: "AUTH MOONLIGHT2024"
   ะกะตัะฒะตั โ Z.:       "CHALLENGE 12345"  โ ะขะะข ะะ!
   ะะณะตะฝั Z. โ ะกะตัะฒะตั: "RESPONSE 67890"  โ ะะะะขะะ!
   ะกะตัะฒะตั:            "ACCESS GRANTED"  โ Z. ะะะจะะ! โ
```

**ะะฐัะธัะฐ: ะดะธะฝะฐะผะธัะตัะบะธะน challenge!**

```
1. ะั (10:48):
   ะกะตัะฒะตั: challenge = random() = 0x7FA3B2C1
   ะั: response = 0x7FA3B2C1 ^ hash("MOONLIGHT2024")
   โ ะะพัััะฟ

2. ะะณะตะฝั Z. (10:50):
   ะกะตัะฒะตั: challenge = random() = 0x1234ABCD  โ ะะะะซะ!
   ะะณะตะฝั Z.: "RESPONSE 0x???"  โ ะกัะฐััะน response ะะ ะะะะฅะะะะข!
   ะกะตัะฒะตั: "AUTH FAILED" โ
```

**ะะพัะตะผั challenge ัะตัะตะท 60 ัะตะบัะฝะด?**
```c
// ะกะตัะฒะตั V.:
time_t current_minute = time(NULL) / 60;
uint32_t challenge = hash(current_minute);  // ะะตะฝัะตััั ะบะฐะถะดัั ะผะธะฝััั

// ะงะตัะตะท 59 ัะตะบัะฝะด โ ัะพั ะถะต challenge
// ะงะตัะตะท 61 ัะตะบัะฝะดั โ ะฝะพะฒัะน challenge
```

**ะะฐัะธัะฐ:**
- ะะตัะตัะฒะฐัะตะฝะฝะฐั ัะตััะธั ัััะฐัะตะฒะฐะตั ะทะฐ 60 ัะตะบัะฝะด
- ะะณะตะฝัั Z. ะฝะต ะผะพะณัั ะฟะตัะตะธัะฟะพะปัะทะพะฒะฐัั
- ะัะถะฝะพ ะทะฝะฐัั ะบะปัั "MOONLIGHT2024"

**ะัั ะปัััะต:** Nonce (ะพะดะฝะพัะฐะทะพะฒัะน, ะฝะต ะฟะพะฒัะพััะตััั ะฝะธะบะพะณะดะฐ):
```c
uint32_t challenge = arc4random();  // ะกะปััะฐะนะฝะพะต ะบะฐะถะดัะน ัะฐะท
```

**ะฃัะพะบ:** Challenge-response + ะดะธะฝะฐะผะธัะตัะบะธะน challenge = ะทะฐัะธัะฐ ะพั replay!
</details>

---

**๐ ะัะตะฝะบะฐ:**
- **13-15 ะฟัะฐะฒะธะปัะฝัั** โ ะพัะปะธัะฝะพ! ะะฐััะตั ัะพะบะตัะพะฒ โ
- **10-12 ะฟัะฐะฒะธะปัะฝัั** โ ัะพัะพัะพ, ะฝะพ ะฟะพะฒัะพัะธัะต challenge-response ๐
- **< 10 ะฟัะฐะฒะธะปัะฝัั** โ ะฟะตัะตัะธัะฐะนัะต Episode 10 ะทะฐะฝะพะฒะพ ๐

---

## ๐ฅ Easter Eggs

<details>
<summary>๐ ะัััะปะบะธ ะธ ัะตะบัะตัั</summary>

1. **Challenge-Response** โ ะบะปะฐััะธัะตัะบะธะน ะฟัะพัะพะบะพะป ะฐััะตะฝัะธัะธะบะฐัะธะธ (CHAP, HTTP Digest)
2. **Hash * 31** โ ะบะปะฐััะธัะตัะบะธะน ะฐะปะณะพัะธัะผ Java `String.hashCode()`
3. **Port 31337** โ ัะฝะพะฒะฐ leet speak (ัะถะต ะทะฝะฐะบะพะผะพ ะธะท Episode 09)
4. **XOR ะดะปั response** โ ัะฟัะพัะตะฝะฝัะน HMAC (ัะตะฐะปัะฝัะต ัะธััะตะผั ะธัะฟะพะปัะทััั SHA-256)
5. **TCP handshake (SYN-SYN/ACK-ACK)** โ ััะฝะดะฐะผะตะฝั ะฒัะตะณะพ TCP
6. **MOONLIGHT2024** โ ะบะปัั ัะพะดะตัะถะธั ะณะพะด, ะฝะฐะผะตะบ ะฝะฐ timeline ะพะฟะตัะฐัะธะธ
7. **V.'s timestamp 14:40** โ 0xE28 hex, ะพัััะปะบะฐ ะบ Enigma machine (E-28 variant)

**ะคะธะปะพัะพัะธั ัะฟะธะทะพะดะฐ**: *"ะกะพะบะตั โ ััะพ ะดะฒะตัั. ะัะพัะพะบะพะป โ ััะพ ะบะปัั. ะะฝะฐะฝะธะต โ ััะพ ะฒะปะฐััั."*

</details>

---

## ๐ ะะฐะฒะธะณะฐัะธั

- [โ Episode 09: Network Basics](../episode-09-network-basics/README.md)
- [โ Episode 11: Packet Analysis](../episode-11-packet-analysis/README.md)
- [๐ Season 3: Networks](../README.md)
- [๐ ะะปะฐะฒะฝะฐั ัััะฐะฝะธัะฐ](../../README.md)

---

> *"Master the socket, master the network. The rest is just data."* โ V.